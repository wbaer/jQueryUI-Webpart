{"version":3,"sources":["KarmaTask.ts"],"names":[],"mappings":";;;;;;AAAA,8DAAoE;AAEpE,uBAAyB;AACzB,uBAAyB;AAEzB,2BAA6B;AAa7B;IAA+B,6BAA0B;IAAzD;QAAA,qEAmIC;QAlIQ,UAAI,GAAW,OAAO,CAAC;QAEvB,gBAAU,GAAqB;YACpC,UAAU,EAAE,mBAAmB;YAC/B,SAAS,EAAE,gBAAgB;SAC5B,CAAC;;IA6HJ,CAAC;IA3HC,sBAAW,gCAAS;aAApB;YACE,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC;gBACrB,IAAI,CAAC,UAAU,GAAG;oBAChB,gBAAgB,EAAE,OAAO,CAAC,OAAO,CAAC,qCAAqC,CAAC;oBACxE,8BAA8B,EAAE,OAAO,CAAC,OAAO,CAAC,8BAA8B,CAAC;oBAC/E,OAAO,EAAE;wBACP,OAAO,CAAC,eAAe,CAAC;wBACxB,OAAO,CAAC,aAAa,CAAC;wBACtB,OAAO,CAAC,gBAAgB,CAAC;wBACzB,OAAO,CAAC,4BAA4B,CAAC;wBACrC,OAAO,CAAC,0BAA0B,CAAC;wBACnC,OAAO,CAAC,kBAAkB,CAAC;qBAC5B;iBACF,CAAC;YACJ,CAAC;YAED,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC;QACzB,CAAC;;;OAAA;IAIM,8BAAU,GAAjB;QACE,MAAM,CAAC,OAAO,CAAC,qBAAqB,CAAC,CAAC;IACxC,CAAC;IAEM,iCAAa,GAApB,UAAqB,WAAyB,EAAE,UAA8C;QAA9C,2BAAA,EAAA,aAA+B,IAAI,CAAC,UAAU;QAC5F,MAAM,CAAC;YACL,IAAI,CAAC,IAAI,CAAC,WAAW,CAAC,UAAU,EAAE,UAAU,CAAC;SAC9C,CAAC;IACJ,CAAC;IAEM,6BAAS,GAAhB,UAAiB,WAAyB;QACxC,MAAM,CAAC,CACL,iBAAM,SAAS,YAAC,WAAW,CAAC;YAC5B,IAAI,CAAC,UAAU,CAAC,UAAU,KAAK,IAAI,CAAC,sCAAsC;SAC3E,CAAC;IACJ,CAAC;IAEM,+BAAW,GAAlB,UAAmB,IAAe,EAAE,gBAAkD;QAAtF,iBAoFC;QAnFS,IAAA,uCAAU,CAAuC;QAEzD,EAAE,CAAC,CAAC,UAAU,IAAI,CAAC,IAAI,CAAC,UAAU,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC;YAC/C,IAAM,eAAe,GAAY,CAAC,OAAO,CAAC,IAAI,CAAC,OAAO,CAAC,aAAa,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;YAE5E,EAAE,CAAC,CAAC,CAAC,eAAe,CAAC,CAAC,CAAC;gBACrB,IAAI,CAAC,UAAU,CACb,qCAAqC;oBACrC,kEAAkE;oBAClE,yDAAyD,CAAC,CAAC;YAC/D,CAAC;YAAC,IAAI,CAAC,CAAC;gBACN,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,SAAS,EAAE,oBAAoB,CAAC,CAAC,CAAC;YAM/D,CAAC;YAED,gBAAgB,EAAE,CAAC;QACrB,CAAC;QAAC,IAAI,CAAC,CAAC;YACN,sDAAsD;YAC9C,IAAA,qCAAS,CAAuC;YACxD,EAAE,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC;gBACd,IAAI,eAAe,SAAQ,CAAC;gBAE5B,EAAE,CAAC,CAAC,OAAO,SAAS,KAAK,QAAQ,CAAC,CAAC,CAAC;oBAClC,IAAI,CAAC;wBACH,eAAe,GAAG,IAAI,MAAM,CAAC,SAAmB,CAAC,CAAC;oBACpD,CAAC;oBAAC,KAAK,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC;wBACf,gBAAgB,CAAC,gEAAgE,GAAG,KAAK,CAAC,QAAQ,EAAE,CAAC,CAAC;wBACtG,MAAM,CAAC;oBACT,CAAC;gBACH,CAAC;gBAAC,IAAI,CAAC,EAAE,CAAC,CAAC,SAAS,YAAY,MAAM,CAAC,CAAC,CAAC;oBACvC,eAAe,GAAG,SAAS,CAAC;gBAC9B,CAAC;gBAAC,IAAI,CAAC,CAAC;oBACN,gBAAgB,CAAC,6CAA6C,CAAC,CAAC;oBAChE,MAAM,CAAC;gBACT,CAAC;gBAED,iCAAiC;gBACjC,IAAM,mBAAmB,GAAW;oBAClC,oCAAkC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,WAAW,CAAC,SAAS,CAAC,iBAAY,eAAe,CAAC,QAAQ,EAAE,OAAI;oBAC7H,kCAAkC;oBAClC,2BAA2B;iBAC5B,CAAC,IAAI,CAAC,EAAE,CAAC,GAAG,CAAC,CAAC;gBACf,gCAAgC;gBAEhC,IAAM,UAAU,GAAW,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,WAAW,CAAC,QAAQ,EAAE,IAAI,CAAC,WAAW,CAAC,UAAU,CAAC,CAAC;gBAC7F,EAAE,CAAC,CAAC,CAAC,EAAE,CAAC,UAAU,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC;oBAC/B,EAAE,CAAC,SAAS,CAAC,UAAU,CAAC,CAAC;gBAC3B,CAAC;gBACD,EAAE,CAAC,aAAa,CAAC,IAAI,CAAC,IAAI,CAAC,UAAU,EAAE,UAAU,CAAC,EAAE,mBAAmB,CAAC,CAAC;YAC3E,CAAC;YAED,IAAM,KAAK,GAAqB,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,sBAAsB;YACxE,IAAM,MAAM,GAAqB,KAAK,CAAC,MAAM,CAAC;YAC9C,IAAM,SAAS,GAAY,CAAC,OAAO,CAAC,IAAI,CAAC,OAAO,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;YACpE,IAAM,UAAU,GAAW,CAAC,OAAO,CAAC,IAAI,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC,CAAC;YAC7D,IAAM,WAAW,GAAW,CAAC,UAAU,KAAK,CAAC,CAAC,CAAC,GAAG,EAAE,GAAG,OAAO,CAAC,IAAI,CAAC,UAAU,GAAG,CAAC,CAAC,CAAC;YAEpF,IAAI,MAAM,CAAC;gBACT,MAAM,EAAE;oBACN,KAAK,EAAE;wBACL,IAAI,EAAE,WAAW;qBAClB;iBACF;gBACD,UAAU,EAAE,IAAI,CAAC,WAAW,CAAC,UAAU,CAAC;gBACxC,SAAS,EAAE,SAAS;aACrB,EAAE,UAAC,QAAQ;gBACV,EAAE,CAAC,CAAC,QAAQ,CAAC,CAAC,CAAC;oBACb,IAAM,OAAO,GAAW,gCAAgC,CAAC;oBACzD,EAAE,CAAC,CAAC,KAAI,CAAC,WAAW,CAAC,UAAU,CAAC,CAAC,CAAC;wBAChC,gBAAgB,CAAC,OAAO,CAAC,CAAC;oBAC5B,CAAC;oBAAC,IAAI,CAAC,CAAC;wBACN,KAAI,CAAC,UAAU,CAAC,OAAO,CAAC,CAAC;wBACzB,gBAAgB,EAAE,CAAC;oBACrB,CAAC;gBACH,CAAC;gBAAC,IAAI,CAAC,CAAC;oBACN,gBAAgB,EAAE,CAAC;gBACrB,CAAC;YACH,CAAC,CAAC,CAAC,KAAK,EAAE,CAAC;QACb,CAAC;IACH,CAAC;IACH,gBAAC;AAAD,CAnIA,AAmIC,CAnI8B,0BAAQ,GAmItC;AAnIY,8BAAS","file":"KarmaTask.js","sourcesContent":["import { GulpTask, IBuildConfig } from '@microsoft/gulp-core-build';\r\n\r\nimport * as os from 'os';\r\nimport * as fs from 'fs';\r\nimport * as gulp from 'gulp';\r\nimport * as path from 'path';\r\nimport * as KarmaType from 'karma';\r\n\r\nexport interface IKarmaTaskConfig {\r\n  configPath: string;\r\n\r\n  /**\r\n   * If specified, a \"tests.js\" file will be created in the temp folder using\r\n   *  this RegExp to locate test files.\r\n   */\r\n  testMatch?: RegExp | string;\r\n}\r\n\r\nexport class KarmaTask extends GulpTask<IKarmaTaskConfig> {\r\n  public name: string = 'karma';\r\n\r\n  public taskConfig: IKarmaTaskConfig = {\r\n    configPath: './karma.config.js',\r\n    testMatch: /.+\\.test\\.js?$/\r\n  };\r\n\r\n  public get resources(): Object {\r\n    if (!this._resources) {\r\n      this._resources = {\r\n        bindPolyfillPath: require.resolve('phantomjs-polyfill/bind-polyfill.js'),\r\n        istanbulInstrumenterLoaderPath: require.resolve('istanbul-instrumenter-loader'),\r\n        plugins: [\r\n          require('karma-webpack'),\r\n          require('karma-mocha'),\r\n          require('karma-coverage'),\r\n          require('karma-mocha-clean-reporter'),\r\n          require('karma-phantomjs-launcher'),\r\n          require('karma-sinon-chai')\r\n        ]\r\n      };\r\n    }\r\n\r\n    return this._resources;\r\n  }\r\n\r\n  private _resources: Object;\r\n\r\n  public loadSchema(): Object {\r\n    return require('./karma.schema.json');\r\n  }\r\n\r\n  public getCleanMatch(buildConfig: IBuildConfig, taskConfig: IKarmaTaskConfig = this.taskConfig): string[] {\r\n    return [\r\n      path.join(buildConfig.tempFolder, 'tests.js')\r\n    ];\r\n  }\r\n\r\n  public isEnabled(buildConfig: IBuildConfig): boolean {\r\n    return (\r\n      super.isEnabled(buildConfig) &&\r\n      this.taskConfig.configPath !== null // tslint:disable-line:no-null-keyword\r\n    );\r\n  }\r\n\r\n  public executeTask(gulp: gulp.Gulp, completeCallback: (error?: Error | string) => void): void {\r\n    const { configPath }: IKarmaTaskConfig = this.taskConfig;\r\n\r\n    if (configPath && !this.fileExists(configPath)) {\r\n      const shouldInitKarma: boolean = (process.argv.indexOf('--initkarma') > -1);\r\n\r\n      if (!shouldInitKarma) {\r\n        this.logWarning(\r\n          `No karma config has been provided. ` +\r\n          `Run again using --initkarma to create a default config, or call ` +\r\n          `karma.setConfig({ configPath: null }) in your gulpfile.`);\r\n      } else {\r\n        this.copyFile(path.resolve(__dirname, '../karma.config.js'));\r\n\r\n        // install dev dependencies?\r\n        // phantomjs-polyfill?\r\n        //\r\n        // install typings for mocha/chai/sinon?\r\n      }\r\n\r\n      completeCallback();\r\n    } else {\r\n      // Normalize the match expression if one was specified\r\n      const { testMatch }: IKarmaTaskConfig = this.taskConfig;\r\n      if (testMatch) {\r\n        let normalizedMatch: RegExp;\r\n\r\n        if (typeof testMatch === 'string') {\r\n          try {\r\n            normalizedMatch = new RegExp(testMatch as string);\r\n          } catch (error) {\r\n            completeCallback('There was an issue parsing your testMatch regular expression: ' + error.toString());\r\n            return;\r\n          }\r\n        } else if (testMatch instanceof RegExp) {\r\n          normalizedMatch = testMatch;\r\n        } else {\r\n          completeCallback('The testMatch regular expression is invalid');\r\n          return;\r\n        }\r\n\r\n        // tslint:disable:max-line-length\r\n        const testsJsFileContents: string = [\r\n          `var context = require.context('${path.posix.join('..', this.buildConfig.libFolder)}', true, ${normalizedMatch.toString()});`,\r\n          `context.keys().forEach(context);`,\r\n          `module.exports = context;`\r\n        ].join(os.EOL);\r\n        // tslint:enable:max-line-length\r\n\r\n        const tempFolder: string = path.join(this.buildConfig.rootPath, this.buildConfig.tempFolder);\r\n        if (!fs.existsSync(tempFolder)) {\r\n          fs.mkdirSync(tempFolder);\r\n        }\r\n        fs.writeFileSync(path.join(tempFolder, 'tests.js'), testsJsFileContents);\r\n      }\r\n\r\n      const karma: typeof KarmaType = require('karma'); // tslint:disable-line\r\n      const server: KarmaType.Server = karma.Server;\r\n      const singleRun: boolean = (process.argv.indexOf('--debug') === -1);\r\n      const matchIndex: number = (process.argv.indexOf('--match'));\r\n      const matchString: string = (matchIndex === -1) ? '' : process.argv[matchIndex + 1];\r\n\r\n      new server({\r\n        client: {\r\n          mocha: {\r\n            grep: matchString\r\n          }\r\n        },\r\n        configFile: this.resolvePath(configPath),\r\n        singleRun: singleRun\r\n      }, (exitCode) => {\r\n        if (exitCode) {\r\n          const message: string = 'Error(s) occured during karma.';\r\n          if (this.buildConfig.production) {\r\n            completeCallback(message);\r\n          } else {\r\n            this.logWarning(message);\r\n            completeCallback();\r\n          }\r\n        } else {\r\n          completeCallback();\r\n        }\r\n      }).start();\r\n    }\r\n  }\r\n}\r\n"],"sourceRoot":"..\\src"}