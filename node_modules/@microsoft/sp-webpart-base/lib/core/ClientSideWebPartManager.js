'use strict';
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var decorators_1 = require("@microsoft/decorators");
var lodash = require("@microsoft/sp-lodash-subset");
var sp_loader_1 = require("@microsoft/sp-loader");
var sp_http_1 = require("@microsoft/sp-http");
var sp_telemetry_1 = require("@ms/sp-telemetry");
var sp_core_library_1 = require("@microsoft/sp-core-library");
var sp_page_context_1 = require("@microsoft/sp-page-context");
var BaseClientSideWebPart_1 = require("./BaseClientSideWebPart");
var ClientSideWebPartStatusRenderer_1 = require("./ClientSideWebPartStatusRenderer");
var EventAggregator_1 = require("./events/EventAggregator");
var ExecuteWithoutFailing_1 = require("../utils/ExecuteWithoutFailing");
var SPWebPartError_1 = require("./error/SPWebPartError");
var PropertyPaneDefinitions_1 = require("../propertyPane/propertyPane/PropertyPaneDefinitions");
var PropertyPaneController_1 = require("../propertyPane/propertyPaneController/PropertyPaneController");
var WebPartContext_1 = require("./WebPartContext");
var ClassicPageUtils_1 = require("./classicPages/ClassicPageUtils");
var Strings_resx_1 = require("./loc/Strings.resx");
var ClientSideWebPartManager = ClientSideWebPartManager_1 = (function () {
    function ClientSideWebPartManager(host) {
        this._webparts = new Map();
        this._logSource = sp_telemetry_1._LogSource.create('ClientSideWebPartManager');
        this._eventAggregator = new EventAggregator_1.default();
        this._statusRenderer = new ClientSideWebPartStatusRenderer_1.default();
        sp_core_library_1.Validate.isNotNullOrUndefined(host, 'host');
        this._host = host;
        this._pageContext = host.serviceScope.consume(sp_page_context_1.PageContext.serviceKey);
        this._onContainerResize = this._onContainerResize.bind(this);
        this._onPropertyPaneToggled = this._onPropertyPaneToggled.bind(this);
        this.setPropertyPaneState = this.setPropertyPaneState.bind(this);
        this.isPropertyPaneRenderedByWebPart = this.isPropertyPaneRenderedByWebPart.bind(this);
        if (ClientSideWebPartManager_1._webPartManagerList.length === 0) {
            this._initialzeOnResizeEventHandler();
        }
        ClientSideWebPartManager_1._webPartManagerList.push(this);
    }
    ClientSideWebPartManager.prototype.loadWebPart = function (context) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            _this._validateInput(context);
            var webPartTag = _this._createWebPartTag(context.manifest, context.instanceId);
            if (context.displayMode === undefined) {
                context.displayMode = sp_core_library_1.DisplayMode.Read;
            }
            if (!_this._validateManifest(context.manifest, context.displayMode, webPartTag)) {
                _this.renderError(context.domElement, SPWebPartError_1.SPWebPartError.create(SPWebPartError_1.SPWebPartErrorCode.ManifestInvalid, webPartTag));
                return;
            }
            var manifest = context.manifest; 
            var instanceId = context.instanceId;
            var domElement = context.domElement;
            var qosMonitor = _this._createLoadQosMonitor(manifest);
            if (context.shouldAddWebpartsToEupl !== false) {
                sp_telemetry_1._PerformanceLogger.addComponent(webPartTag);
            }
            sp_telemetry_1._PerformanceLogger.startMarkForComponent(webPartTag);
            sp_telemetry_1._TraceLogger.logVerboseData({
                source: _this._logSource,
                message: sp_core_library_1.Text.format(Strings_resx_1.default.StartedLoadingWebPart, webPartTag),
                serviceScope: _this._host.serviceScope
            });
            var title = context.webPartData && context.webPartData.title
                ? context.webPartData.title
                : (manifest.title && manifest.title.default 
                    ? manifest.title.default 
                    : manifest.preconfiguredEntries[0].title.default);
            _this._statusRenderer.displayLoadingIndicator(domElement, title);
            var modulePromise = sp_loader_1.SPComponentLoader.loadComponent(manifest);
            if (modulePromise) {
                modulePromise.then(function (moduleLibrary) {
                    sp_telemetry_1._PerformanceLogger.markComponentModuleLoaded(webPartTag);
                    sp_telemetry_1._TraceLogger.logVerboseData({
                        source: _this._logSource,
                        message: sp_core_library_1.Text.format(Strings_resx_1.default.ModulesLoadedForWebPart, webPartTag),
                        serviceScope: _this._host.serviceScope
                    });
                    if (!moduleLibrary) {
                        throw SPWebPartError_1.SPWebPartError.create(SPWebPartError_1.SPWebPartErrorCode.ModuleUndefined, webPartTag);
                    }
                    try {
                        var wp = moduleLibrary; 
                        if (wp && wp.default) {
                            wp = wp.default;
                        }
                        if (!wp) {
                            throw SPWebPartError_1.SPWebPartError.create(SPWebPartError_1.SPWebPartErrorCode.ModuleNotLoaded, webPartTag, _this._getLoadedModuleList(moduleLibrary));
                        }
                        if (typeof (wp) !== 'function' && wp.default) {
                            wp = wp.default;
                        }
                        if (typeof (wp) !== 'function') {
                            throw SPWebPartError_1.SPWebPartError.createWithLogProperties(SPWebPartError_1.SPWebPartErrorCode.IncorrectBoostrapModule, { actualType: typeof (wp), wp: wp }, webPartTag);
                        }
                        var typedWebPartClass = wp;
                        var wpi = new typedWebPartClass();
                        if (!wpi._internalInitialize) {
                            throw SPWebPartError_1.SPWebPartError.createWithLogProperties(SPWebPartError_1.SPWebPartErrorCode.MissingExpectedWebPartMemberError, { actualType: typeof (wp), wp: wp }, webPartTag, '_internalInitialize');
                        }
                        wpi._internalInitialize(_this._getWebPartContext(context));
                        _this._webparts.set(instanceId, wpi);
                        _this._startDirtyBitTimer(context.displayMode);
                        var webPartData = lodash.cloneDeep(context.webPartData);
                        if (_this._instanceOfBase(wpi)) {
                            return wpi._internalFirstTimeRender(context.addedFromPersistedData, context.displayMode, qosMonitor, webPartData).then(function () {
                                var extraData = _this._createSuccessExtraData(manifest.alias, manifest.isInternal, manifest.id);
                                qosMonitor.writeSuccess(extraData);
                                sp_telemetry_1._PerformanceLogger.endMarkForComponent(webPartTag);
                                ClassicPageUtils_1.default.removeFabricLinks();
                                sp_telemetry_1._TraceLogger.logVerboseData({
                                    source: _this._logSource,
                                    message: sp_core_library_1.Text.format(Strings_resx_1.default.ModulesLoadedForWebPart, webPartTag),
                                    serviceScope: _this._host.serviceScope
                                });
                                resolve();
                            });
                        }
                        else {
                            throw SPWebPartError_1.SPWebPartError.create(SPWebPartError_1.SPWebPartErrorCode.NonBaseWebPart, webPartTag);
                        }
                    }
                    catch (ex) {
                        var wpi_1 = _this._webparts.get(instanceId);
                        if (wpi_1) {
                            ExecuteWithoutFailing_1.executeWithoutFailing(function () { _this._statusRenderer.clearLoadingIndicator(domElement); }, _this._logSource);
                            ExecuteWithoutFailing_1.executeWithoutFailing(function () { wpi_1._internalDispose(); }, _this._logSource);
                            ExecuteWithoutFailing_1.executeWithoutFailing(function () { _this._webparts.delete(instanceId); }, _this._logSource);
                        }
                        ExecuteWithoutFailing_1.executeWithoutFailing(function () {
                            var extraData = _this._createUnexpectedFailureExtraData(manifest.alias, instanceId, manifest.isInternal, manifest.id);
                            qosMonitor.writeUnexpectedFailure('UnhandledLoadError', ex, extraData);
                        }, _this._logSource);
                        _this.renderError(domElement, ex);
                        reject();
                    }
                }).catch(function (errorMsg) {
                    var err = SPWebPartError_1.SPWebPartError.create(SPWebPartError_1.SPWebPartErrorCode.ScriptLoadError, webPartTag, errorMsg);
                    ExecuteWithoutFailing_1.executeWithoutFailing(function () {
                        var extraData = _this._createUnexpectedFailureExtraData(manifest.alias, instanceId, manifest.isInternal, manifest.id);
                        qosMonitor.writeUnexpectedFailure('ScriptLoad', err, extraData);
                    }, _this._logSource);
                    _this.renderError(domElement, err);
                    reject();
                });
            }
            else {
                var error = SPWebPartError_1.SPWebPartError.create(SPWebPartError_1.SPWebPartErrorCode.LoaderNotFound, webPartTag);
                _this.renderError(domElement, error);
                reject();
            }
        });
    };
    ClientSideWebPartManager.prototype.setPropertyPaneControl = function (id, control) {
        sp_core_library_1.Validate.isNonemptyString(id, 'id');
        sp_core_library_1.Validate.isNotNullOrUndefined(control, 'control');
        this._webparts.set(id, control);
    };
    ClientSideWebPartManager.prototype.fetchWebPartManifests = function () {
        var _this = this;
        if (!this._toolboxManifestsPromise) {
            var qosMonitor_1 = new sp_telemetry_1._QosMonitor('ClientSideWebPartManager.FetchWebParts');
            this._toolboxManifestsPromise = new Promise(function (resolve, reject) {
                if (_this._pageContext.web &&
                    _this._pageContext.web.serverRelativeUrl &&
                    sp_core_library_1.Environment.type !== sp_core_library_1.EnvironmentType.Local &&
                    sp_core_library_1.Environment.type !== sp_core_library_1.EnvironmentType.Test) {
                    var requestUrl_1 = sp_core_library_1.UrlUtilities.removeEndSlash(_this._pageContext.web.serverRelativeUrl) + "/_api/web/GetClientSideWebParts";
                    _this._host.serviceScope.whenFinished(function () {
                        var httpClient = _this._host.serviceScope.consume(sp_http_1.SPHttpClient.serviceKey);
                        httpClient.get(requestUrl_1, sp_http_1.SPHttpClient.configurations.v1)
                            .then(function (response) {
                            return response.json();
                        })
                            .then(function (value) {
                            var manifests = value.value.map(function (manifestObject) { return JSON.parse(manifestObject.Manifest); });
                            _this._disambiguateWebPartManifestLocales(manifests);
                            sp_loader_1.SPComponentLoader.registerManifests(manifests);
                            sp_telemetry_1._TraceLogger.logVerboseData({
                                source: _this._logSource,
                                message: Strings_resx_1.default.CompletedLoadingWebPartManifests,
                                serviceScope: _this._host.serviceScope
                            });
                            qosMonitor_1.writeSuccess();
                            resolve();
                        })
                            .catch(function (error) {
                            _this._toolboxManifestsPromise = undefined;
                            sp_telemetry_1._TraceLogger.logErrorData({
                                source: _this._logSource,
                                error: error,
                                serviceScope: _this._host.serviceScope
                            });
                            qosMonitor_1.writeUnexpectedFailure('Rejected', error);
                            reject(error);
                        });
                    });
                }
                else {
                    resolve();
                }
            });
        }
        return this._toolboxManifestsPromise;
    };
    ClientSideWebPartManager.prototype.getWebPartManifests = function () {
        var manifests = sp_loader_1.SPComponentLoader.getManifests();
        var result = []; 
        if (manifests) {
            for (var _i = 0, manifests_1 = manifests; _i < manifests_1.length; _i++) {
                var manifest = manifests_1[_i];
                if (manifest && manifest.componentType === 'WebPart') {
                    result.push(manifest); 
                }
            }
        }
        return result;
    };
    ClientSideWebPartManager.prototype.setDisplayMode = function (displayMode, instanceId) {
        this._executeForIdsOrAll(this._getArrayOrUndefined(instanceId), function (wp) {
            wp._internalSetDisplayMode(displayMode);
        });
        this._startDirtyBitTimer(displayMode);
    };
    ClientSideWebPartManager.prototype.serialize = function (instanceId) {
        var sd = new Map();
        this._executeForIdsOrAll(this._getArrayOrUndefined(instanceId), function (wp, _instanceId) {
            sd.set(_instanceId, wp._internalSerialize());
        });
        return sd;
    };
    ClientSideWebPartManager.prototype.dispose = function (instanceId) {
        var _this = this;
        this._executeForIdsOrAll(this._getArrayOrUndefined(instanceId), function (wp, _instanceId) {
            ExecuteWithoutFailing_1.executeWithoutFailing(function () { wp._internalDispose(); }, _this._logSource);
            _this._deleteWebPart(_instanceId);
        });
    };
    ClientSideWebPartManager.prototype.tryGeneratePreviewImageUrl = function (instanceIds) {
        var previewImageUrl = undefined;
        this._executeForIdsOrAll(instanceIds, function (wp, id) {
            if (!previewImageUrl) {
                previewImageUrl = wp.previewImageUrl;
            }
        });
        return previewImageUrl;
    };
    ClientSideWebPartManager.prototype.setPropertyPaneState = function (instanceId, propertyPaneState, renderedByWebPart) {
        if (propertyPaneState === void 0) { propertyPaneState = PropertyPaneDefinitions_1.PropertyPaneState.Default; }
        if (!ClientSideWebPartManager_1._propertyPaneController) {
            ClientSideWebPartManager_1._propertyPaneController =
                new PropertyPaneController_1.default(function (wpId) {
                    var wp = undefined;
                    for (var i = 0; i < ClientSideWebPartManager_1._webPartManagerList.length; i++) {
                        wp = ClientSideWebPartManager_1._webPartManagerList[i]._webparts.get(wpId);
                        if (wp) {
                            break;
                        }
                    }
                    return wp;
                }, this._onWebPartConfigurationChange);
        }
        ClientSideWebPartManager_1._propertyPaneController.setPropertyPaneState(instanceId, propertyPaneState, renderedByWebPart);
    };
    ClientSideWebPartManager.prototype.isPropertyPaneRenderedByWebPart = function () {
        return ClientSideWebPartManager_1._propertyPaneController.isRenderedByWebPart();
    };
    ClientSideWebPartManager.prototype.onWebPartDelete = function (instanceId) {
        this.dispose(instanceId);
    };
    ClientSideWebPartManager.prototype.renderError = function (domElement, error) {
        var _this = this;
        ExecuteWithoutFailing_1.executeWithoutFailing(function () {
            _this._statusRenderer.renderError(domElement, error);
            sp_telemetry_1._TraceLogger.logErrorData({
                source: _this._logSource,
                error: error,
                serviceScope: _this._host.serviceScope
            });
        }, this._logSource);
    };
    ClientSideWebPartManager.prototype._disambiguateWebPartManifestLocales = function (manifests) {
        var currentLocale = this._pageContext.cultureInfo.currentUICultureName
            ? this._pageContext.cultureInfo.currentUICultureName.toLowerCase()
            : undefined;
        if (currentLocale) {
            var disambiguateLocale_1 = function (values) {
                var foundMatch = undefined;
                for (var locale in values) {
                    if (locale && locale.toLowerCase() === currentLocale && values[locale]) {
                        foundMatch = values[locale];
                        break;
                    }
                }
                return {
                    default: foundMatch || values['default']
                };
            };
            manifests.forEach(function (manifest) {
                if (manifest.componentType === 'WebPart') {
                    var wpManifest = manifest;
                    wpManifest.preconfiguredEntries.forEach(function (entry) {
                        entry.title = disambiguateLocale_1(entry.title);
                        entry.description = disambiguateLocale_1(entry.description);
                        if (entry.group) {
                            entry.group = disambiguateLocale_1(entry.group);
                        }
                    });
                }
            });
        }
    };
    ClientSideWebPartManager.prototype._validateInput = function (context) {
        sp_core_library_1.Validate.isNotNullOrUndefined(context, 'web part manager context');
        sp_core_library_1.Validate.isNotNullOrUndefined(context.domElement, 'web part element');
        sp_core_library_1.Validate.isNotNullOrUndefined(context.instanceId, 'web part instanceId');
        sp_core_library_1.Validate.isNotNullOrUndefined(context.manifest, 'web part manifest');
        sp_core_library_1.Validate.isTrue(!this._webparts.get(context.instanceId), 'Duplicate web part id not allowed');
    };
    ClientSideWebPartManager.prototype._validateManifest = function (manifest,  mode, webPartTag) {
        if (!manifest) {
            if (mode === sp_core_library_1.DisplayMode.Read) {
                throw SPWebPartError_1.SPWebPartError.create(SPWebPartError_1.SPWebPartErrorCode.ManifestNull, webPartTag);
            }
            else {
                return false;
            }
        }
        var cm = lodash.cloneDeep(manifest);
        sp_core_library_1.Validate.isTrue(cm.manifestVersion == 2, 'Only version 2 manifests are currently supported');
        sp_core_library_1.Validate.isTrue(!!cm.id, 'web part id cannot be null or undefined');
        sp_core_library_1.Validate.isNotNullOrUndefined(sp_core_library_1.Guid.tryParse(cm.id), 'web part id has to be a GUID');
        sp_core_library_1.Validate.isTrue(!!cm.version, 'webp art version cannot be null or undefined');
        return true;
    };
    ClientSideWebPartManager.prototype._executeForIdsOrAll = function (instanceIds, cb) {
        var _this = this;
        if (instanceIds) {
            instanceIds.forEach(function (id) {
                var wp = _this._webparts.get(id);
                if (wp) {
                    cb(wp, id);
                }
            });
        }
        else {
            this._webparts.forEach(function (wp, id) {
                if (wp && (wp['__type'] === 'BaseClientSideWebPart' || wp instanceof BaseClientSideWebPart_1.default)) {
                    cb(wp, id);
                }
            });
        }
    };
    ClientSideWebPartManager.prototype._getWebPartContext = function (context) {
        var webPartTag = this._createWebPartTag(context.manifest, context.instanceId);
        var parameters = {
            parentServiceScope: this._host.serviceScope,
            manifest: this._getManifestInstance(context),
            instanceId: context.instanceId,
            webPartTag: webPartTag,
            domElement: context.domElement,
            statusRenderer: this._statusRenderer,
            eventAggregator: this._eventAggregator,
            isPropertyPaneRenderedByWebPart: this.isPropertyPaneRenderedByWebPart,
            host: this._host,
            setPropertyPaneState: this.setPropertyPaneState
        };
        return new WebPartContext_1.default(parameters);
    };
    ClientSideWebPartManager.prototype._instanceOfBase = function (wpi) {
        return wpi instanceof BaseClientSideWebPart_1.default || wpi['__type'] === 'BaseClientSideWebPart';
    };
    ClientSideWebPartManager.prototype._getLoadedModuleList = function (moduleLibrary) {
        var loadedModulesString = '';
        for (var m in moduleLibrary) {
            if (moduleLibrary.hasOwnProperty(m)) {
                if (loadedModulesString) {
                    loadedModulesString += ',';
                }
                loadedModulesString += "" + m;
            }
        }
        return loadedModulesString;
    };
    ClientSideWebPartManager.prototype._startDirtyBitTimer = function (mode) {
        var _this = this;
        if (mode === sp_core_library_1.DisplayMode.Read) {
            if (this._dirtyBitTimer && sp_core_library_1.Environment.type !== sp_core_library_1.EnvironmentType.ClassicSharePoint) {
                window.clearInterval(this._dirtyBitTimer);
                this._dirtyBitTimer = undefined;
            }
        }
        else if (!this._dirtyBitTimer) {
            this._dirtyBitTimer = window.setInterval(function () {
                _this._executeForIdsOrAll(undefined, function (wp) {
                    wp._internalSetDirtyBit();
                });
            }, 1000);
        }
    };
    ClientSideWebPartManager.prototype._createSuccessExtraData = function (alias, isInternal, manifestId) {
        var successExtraData = {
            alias: alias,
            isInternal: isInternal,
            manifestId: manifestId
        };
        return successExtraData;
    };
    ClientSideWebPartManager.prototype._createUnexpectedFailureExtraData = function (alias, instanceId, isInternal, manifestId) {
        var unexpectedFailureExtraData = {
            alias: alias,
            instanceId: instanceId,
            isInternal: isInternal,
            manifestId: manifestId
        };
        return unexpectedFailureExtraData;
    };
    ClientSideWebPartManager.prototype._createLoadQosMonitor = function (manifest) {
        return new sp_telemetry_1._QosMonitor("WebPart.Load");
    };
    ClientSideWebPartManager.prototype._createWebPartTag = function (manifest, instanceId) {
        return "WebPart." + manifest.alias + "." + instanceId;
    };
    ClientSideWebPartManager.prototype._deleteWebPart = function (id) {
        sp_core_library_1.Validate.isNotNullOrUndefined(id, 'id');
        if (ClientSideWebPartManager_1._propertyPaneController) {
            ClientSideWebPartManager_1._propertyPaneController.onWebPartDelete(id);
        }
        this._webparts.delete(id);
    };
    ClientSideWebPartManager.prototype._getManifestInstance = function (context) {
        var manifest = context.manifest;
        var manifestClone = lodash.cloneDeep(manifest);
        delete manifestClone.preconfiguredEntries;
        return manifestClone;
    };
    ClientSideWebPartManager.prototype._getArrayOrUndefined = function (instanceId) {
        return instanceId ? [instanceId] : undefined;
    };
    ClientSideWebPartManager.prototype._initialzeOnResizeEventHandler = function () {
        window.addEventListener('resize', lodash.debounce(this._onContainerResize, 1000));
        window.addEventListener('message', this._onPropertyPaneToggled);
    };
    ClientSideWebPartManager.prototype._onContainerResize = function () {
        ClientSideWebPartManager_1._webPartManagerList.forEach(function (wpm) {
            wpm._webparts.forEach(function (wp) { wp._internalOnAfterResize(); });
        });
    };
    ClientSideWebPartManager.prototype._onPropertyPaneToggled = function (event) {
        if (event && event.origin === window.location.origin && event.data === 'Property pane toggled') {
            this._onContainerResize();
        }
    };
    ClientSideWebPartManager.prototype._onWebPartConfigurationChange = function (event, data) {
        ClientSideWebPartManager_1._webPartManagerList.forEach(function (wpm) {
            if (wpm._host.webPartConfigurationEventCallback &&
                (ClientSideWebPartManager_1._propertyPaneController.currentlyConfiguredWebPartId &&
                    wpm._webparts.get(ClientSideWebPartManager_1._propertyPaneController.currentlyConfiguredWebPartId) ||
                    event === PropertyPaneDefinitions_1.WebPartConfigurationEvent.PropertyPaneWebPartsSwitched)) {
                wpm._host.webPartConfigurationEventCallback(event, data);
            }
        });
    };
    return ClientSideWebPartManager;
}());
ClientSideWebPartManager._webPartManagerList = [];
ClientSideWebPartManager = ClientSideWebPartManager_1 = __decorate([
    decorators_1.sealed
], ClientSideWebPartManager);
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = ClientSideWebPartManager;
var ClientSideWebPartManager_1;
