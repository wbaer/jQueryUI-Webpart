{"version":3,"sources":["packageSolution/packageSolution/utils/normalizeSolutionDefinition.ts"],"names":[],"mappings":"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","file":"packageSolution/packageSolution/utils/normalizeSolutionDefinition.js","sourcesContent":["/**\r\n * @file normalizeSolutionDefinition.ts\r\n * @Copyright (c) Microsoft Corporation.  All rights reserved.\r\n *\r\n * Using a manifest map, creates component definitions and updates a package definition's element guids with\r\n * actual objects\r\n */\r\n\r\nimport * as path from 'path';\r\nimport IFeature from '../models/packageDefinition/IFeature';\r\nimport { IPackageSolutionTaskConfig } from '../../PackageSolutionTask';\r\nimport IComponent,\r\n{\r\n  IWebPartDefinition,\r\n  IWebPartEntryDefinition\r\n} from '../models/packageDefinition/IComponent';\r\nimport componentType from '../models/ComponentType';\r\nimport { log } from '@microsoft/gulp-core-build';\r\n\r\nimport {\r\n  IClientSideComponentManifest,\r\n  IClientSideWebPartManifest,\r\n  IClientSideCodePartManifest,\r\n  IClientSideWebPartManifestEntry,\r\n  IClientSideApplicationManifest\r\n} from '@microsoft/sp-module-interfaces';\r\n\r\nfunction createComponent(manifest: IClientSideComponentManifest): IComponent {\r\n  if (!manifest.id || !manifest || !manifest.componentType) {\r\n    return undefined;\r\n  }\r\n\r\n  if (manifest.componentType === 'Application') {\r\n    return createApplicationComponent(manifest as IClientSideApplicationManifest);\r\n  } else if (manifest.componentType === 'WebPart') {\r\n    return createWebPartComponent(manifest as IClientSideWebPartManifest<{}>);\r\n  } else if (manifest.componentType === 'CodePart') {\r\n    return createCodePartComponent(manifest as IClientSideCodePartManifest);\r\n  } else {\r\n    log(`Component type '${manifest.componentType}' not recognized. Skipping manifest.`);\r\n    return undefined;\r\n  }\r\n\r\n}\r\n\r\nfunction createCodePartComponent(manifest: IClientSideCodePartManifest): IComponent {\r\n  return {\r\n    name: manifest.alias,\r\n    description: `${manifest.codePartType} - ${manifest.alias}`,\r\n    id: manifest.id,\r\n    manifest: JSON.stringify(manifest),\r\n    type: componentType[manifest.componentType],\r\n    componentDefinition: {}\r\n  };\r\n}\r\n\r\nfunction createApplicationComponent(manifest: IClientSideApplicationManifest): IComponent {\r\n  return {\r\n    name: manifest.title.default,\r\n    description: manifest.description.default,\r\n    id: manifest.id,\r\n    manifest: JSON.stringify(manifest),\r\n    type: componentType[manifest.componentType],\r\n    componentDefinition: {}\r\n  };\r\n}\r\n\r\nfunction createWebPartComponent(manifest: IClientSideWebPartManifest<{}>): IComponent {\r\n  let i: number = 0;\r\n  const entries: IWebPartEntryDefinition[] =\r\n      manifest.preconfiguredEntries.map((entry: IClientSideWebPartManifestEntry<{}>): IWebPartEntryDefinition => {\r\n    return {\r\n      id: manifest.id + '_' + i++,\r\n      name: entry.title.default,\r\n      description: entry.description.default,\r\n      webPartData: buildWebPartData(manifest, entry)\r\n    };\r\n  });\r\n\r\n  // Use the first entry name and description for the component\r\n  return {\r\n    name: manifest.preconfiguredEntries[0].title.default,\r\n    description: manifest.preconfiguredEntries[0].description.default,\r\n    id: manifest.id,\r\n    manifest: JSON.stringify(manifest),\r\n    type: componentType[manifest.componentType],\r\n    componentDefinition: {\r\n      entries: entries\r\n    } as IWebPartDefinition\r\n  };\r\n}\r\n\r\n// tslint:disable:no-any\r\nfunction buildWebPartData(\r\n    manifest: IClientSideWebPartManifest<any>,\r\n    entry: IClientSideWebPartManifestEntry<any>): string {\r\n// tslint:enable:no-any\r\n  return JSON.stringify({\r\n    id: manifest.id,\r\n    instanceId: undefined,\r\n    title: entry.title.default,\r\n    description: entry.description.default,\r\n    version: manifest.version,\r\n    properties: entry.properties\r\n  });\r\n}\r\n\r\nfunction createComponentMapFromManifests(manifests: Map<string, IClientSideComponentManifest>):\r\n  Map<string, IComponent> {\r\n  log(`Attempting creating component definitions for {${manifests.size}} manifests`);\r\n  const components: Map<string, IComponent> = new Map<string, IComponent>();\r\n  manifests.forEach((manifest, key: string) => {\r\n    const component: IComponent = createComponent(manifest);\r\n    if (component) {\r\n      components.set(key, component);\r\n    }\r\n  });\r\n\r\n  log(`Created component definitions for {${components.size}} manifests`);\r\n  return components;\r\n}\r\n\r\nfunction createFeatureFromComponent(component: IComponent): IFeature {\r\n  const componentTypeStr: string = (component.type === componentType.WebPart ? 'WebPart' : 'Application');\r\n\r\n  return {\r\n    title: `${component.name} Feature`,\r\n    description: `A feature which activates the Client-Side ${componentTypeStr} named ${component.name}`,\r\n    id: component.id, // @todo - this is a hack, we need a better way of doing this\r\n    components: [component],\r\n    assets: {\r\n      elementFiles: [],\r\n      elementManifests: [],\r\n      upgradeActions: []\r\n    }\r\n  };\r\n}\r\n\r\n/**\r\n * Normalizes the passed in solution definition by cross referencing componentIds with the collected list\r\n * of manifests in the repo. If, for any feature, the componentId list is missing or empty, we add all the\r\n * components to that feature. Similarly, if the list of features in the solution is empty or missing, a\r\n * feature is automatically created for all solutions.\r\n */\r\nexport default\r\n  function normalizeSolutionDefinition(options: IPackageSolutionTaskConfig,\r\n  manifests: Map<string, IClientSideComponentManifest>): void {\r\n\r\n  const componentMap: Map<string, IComponent> = createComponentMapFromManifests(manifests);\r\n  const numManifests: number = componentMap.size;\r\n\r\n  if (numManifests === 0) {\r\n    throw 'Could not find any valid manifests. Please double check paths.manifestsMatch in the task config.';\r\n  }\r\n\r\n  // Then, replace the guids in the solution definition with the component definition\r\n  if (options.solution && options.solution.features) {\r\n    for (const feature of options.solution.features) {\r\n      if (feature.componentIds && feature.componentIds.length > 0) {\r\n        feature.components = feature.componentIds.map((componentId: string): IComponent => {\r\n          const manifest: IComponent = componentMap.get(componentId);\r\n          if (!manifest) {\r\n            throw new Error(\r\n              `Component {${componentId as string}} does not exist in feature '${feature.title}'. `\r\n              + 'Please update your configuration.');\r\n          }\r\n          return manifest;\r\n        });\r\n      } else {\r\n        log('feature.componentIds not set! ' +\r\n                    `Adding all [${numManifests}] components to feature { ${feature.title } }.`);\r\n        feature.components = [];\r\n        componentMap.forEach((component: IComponent) => {\r\n          feature.components.push(component);\r\n        });\r\n      }\r\n\r\n      if (!feature.assets) {\r\n        feature.assets = {\r\n          elementFiles: [],\r\n          elementManifests: [],\r\n          upgradeActions: []\r\n        };\r\n      }\r\n      feature.assets.elementFiles =\r\n        appendBasePathToFeatureFiles(feature.assets.elementFiles, options.paths.sharepointAssetDir);\r\n      feature.assets.elementManifests =\r\n        appendBasePathToFeatureFiles(feature.assets.elementManifests, options.paths.sharepointAssetDir);\r\n      feature.assets.upgradeActions =\r\n        appendBasePathToFeatureFiles(feature.assets.upgradeActions, options.paths.sharepointAssetDir);\r\n    }\r\n  } else {\r\n    log('config.solution.features not set! Instead generating a feature for each component.');\r\n    options.solution.features = [];\r\n    componentMap.forEach((component: IComponent) => {\r\n      log(`Creating feature for ${component.name}...`);\r\n      options.solution.features.push(createFeatureFromComponent(component));\r\n    });\r\n  }\r\n}\r\n\r\nfunction appendBasePathToFeatureFiles(files: string[], basePath: string): string[] {\r\n  if (files) {\r\n    return files.map((filename) => path.posix.join(basePath, filename));\r\n  }\r\n  return [];\r\n}\r\n"],"sourceRoot":"..\\..\\..\\..\\src"}