'use strict';
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var decorators_1 = require("@microsoft/decorators");
var lodash = require("@microsoft/sp-lodash-subset");
var sp_telemetry_1 = require("@ms/sp-telemetry");
var sp_core_library_1 = require("@microsoft/sp-core-library");
var PropertyPaneDefinitions_1 = require("../propertyPane/propertyPane/PropertyPaneDefinitions");
var SPWebPartError_1 = require("./error/SPWebPartError");
var Object_1 = require("../utils/Object");
var ExecuteAndReThrow_1 = require("../utils/ExecuteAndReThrow");
var ClassicPageUtils_1 = require("./classicPages/ClassicPageUtils");
var ViewportLoader_1 = require("./ViewportLoader");
var Strings_resx_1 = require("./loc/Strings.resx");
var cswp_base_module_scss_1 = require("./styles/cswp-base.module.scss");
var WEBPARTLOADINVIEWPORTFLIGHT = 33;
var BaseClientSideWebPart = (function () {
    function BaseClientSideWebPart() {
        this._initialized = false;
        this._logSource = sp_telemetry_1._LogSource.create('BaseClientSideWebPart');
        this._isInViewport = false;
        if (this.constructor['name'] === 'BaseClientSideWebPart') {
            throw SPWebPartError_1.SPWebPartError.create(SPWebPartError_1.SPWebPartErrorCode.BaseConstructError);
        }
    }
    Object.defineProperty(BaseClientSideWebPart.prototype, "context", {
        get: function () {
            if (this._initialized) {
                return this._context;
            }
            else {
                throw SPWebPartError_1.SPWebPartError.create(SPWebPartError_1.SPWebPartErrorCode.NotInitializedError);
            }
        },
        set: function (o) { this._throwReadOnlyError(); },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BaseClientSideWebPart.prototype, "domElement", {
        get: function () { return this._context.domElement; },
        set: function (o) { this._throwReadOnlyError(); },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BaseClientSideWebPart.prototype, "width", {
        get: function () { return this.domElement.clientWidth; },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BaseClientSideWebPart.prototype, "dataVersion", {
        get: function () {
            return sp_core_library_1.Version.parse('1.0');
        },
        enumerable: true,
        configurable: true
    });
    ;
    Object.defineProperty(BaseClientSideWebPart.prototype, "displayMode", {
        get: function () { return this._displayMode; },
        set: function (o) { this._throwReadOnlyError(); },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BaseClientSideWebPart.prototype, "properties", {
        get: function () {
            if (this._initialized) {
                return this._properties;
            }
            else {
                throw SPWebPartError_1.SPWebPartError.create(SPWebPartError_1.SPWebPartErrorCode.NotInitializedError);
            }
        },
        set: function (o) { this._throwReadOnlyError(); },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BaseClientSideWebPart.prototype, "propertiesMetadata", {
        get: function () { return undefined; },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BaseClientSideWebPart.prototype, "renderedOnce", {
        get: function () { return this._renderedOnce; },
        set: function (o) { this._throwReadOnlyError(); },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BaseClientSideWebPart.prototype, "renderedFromPersistedData", {
        get: function () { return this._renderedFromPersistedData; },
        set: function (o) { this._throwReadOnlyError(); },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BaseClientSideWebPart.prototype, "canOpenPopupOnRender", {
        get: function () {
            return true;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BaseClientSideWebPart.prototype, "disableReactivePropertyChanges", {
        get: function () { return false; },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BaseClientSideWebPart.prototype, "previewImageUrl", {
        get: function () { return undefined; },
        set: function (o) { this._throwReadOnlyError(); },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BaseClientSideWebPart.prototype, "accessibleTitle", {
        get: function () { return this._getDefaultAccessibleTitle(); },
        set: function (o) { this._throwReadOnlyError(); },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BaseClientSideWebPart.prototype, "title", {
        get: function () { return this._title; },
        set: function (o) { this._throwReadOnlyError(); },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BaseClientSideWebPart.prototype, "description", {
        get: function () { return this._description; },
        set: function (o) { this._throwReadOnlyError(); },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BaseClientSideWebPart.prototype, "isRenderAsync", {
        get: function () { return false; },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BaseClientSideWebPart.prototype, "instanceId", {
        set: function (o) { this._throwReadOnlyError(); },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BaseClientSideWebPart.prototype, "propertyPaneRenderedByWebPart", {
        set: function (o) { this._throwReadOnlyError(); },
        enumerable: true,
        configurable: true
    });
    BaseClientSideWebPart.prototype.onInit = function () {
        return Promise.resolve(undefined);
    };
    BaseClientSideWebPart.prototype.renderCompleted = function () {
        this._renderCompleted();
    };
    BaseClientSideWebPart.prototype.onDisplayModeChanged = function (oldDisplayMode) {
        sp_core_library_1.Validate.isTrue(oldDisplayMode !== this.displayMode, Strings_resx_1.default.OnDisplayModeChangedInvalidInvocation);
        this._renderWithAccessibileTitle();
    };
    BaseClientSideWebPart.prototype.onBeforeSerialize = function () {
        return undefined;
    };
    BaseClientSideWebPart.prototype.onAfterDeserialize = function (deserializedObject, dataVersion) {
        return deserializedObject;
    };
    ;
    BaseClientSideWebPart.prototype.onEvent = function (eventName, eventObject) {
    };
    BaseClientSideWebPart.prototype.getPropertyPaneConfiguration = function () {
        return undefined; 
    };
    BaseClientSideWebPart.prototype.onDispose = function () {
        if (sp_core_library_1._SPFlight.isEnabled(WEBPARTLOADINVIEWPORTFLIGHT) && !this.context.host.isViewportLoadingDisabled
            && !this._isInViewport) {
            BaseClientSideWebPart._viewportLoader.unregister(this);
        }
    };
    BaseClientSideWebPart.prototype.onPropertyPaneFieldChanged = function (propertyPath, oldValue, newValue) {
        if (!this.disableReactivePropertyChanges) {
            this._renderWithAccessibileTitle();
        }
    };
    BaseClientSideWebPart.prototype.onPropertyPaneConfigurationStart = function () {
    };
    BaseClientSideWebPart.prototype.onPropertyPaneConfigurationComplete = function () {
    };
    BaseClientSideWebPart.prototype.onAfterPropertyPaneChangesApplied = function () {
    };
    BaseClientSideWebPart.prototype.onPropertyPaneRendered = function () {
    };
    BaseClientSideWebPart.prototype.onAfterResize = function (newWidth) {
    };
    BaseClientSideWebPart.prototype.renderError = function (error) {
        this.context.statusRenderer.clearLoadingIndicator(this.domElement);
        this.context.statusRenderer.renderError(this.domElement, error);
        sp_telemetry_1._TraceLogger.logError(this._logSource, error);
    };
    BaseClientSideWebPart.prototype.clearError = function () {
        this.context.statusRenderer.clearError(this.domElement);
    };
    BaseClientSideWebPart.prototype._reInstateServerProcessedData = function (deserializedProperties, serverProcessedContent) {
        var _this = this;
        if (!deserializedProperties) {
            return {};
        }
        var fixedProperties = deserializedProperties;
        if (!this.renderedFromPersistedData) {
            return fixedProperties;
        }
        this._forEachPropertyWithMetaData(function (propPath, metadata) {
            if (_this.context.manifest.id !== 'b7dd04e1-19ce-4b24-9132-b60a1c2b910d') {
                lodash.set(fixedProperties, propPath, undefined);
            }
        }, fixedProperties);
        if (serverProcessedContent) {
            var htmlMaps = [serverProcessedContent.htmlStrings, serverProcessedContent.imageSources, serverProcessedContent.links];
            for (var _i = 0, htmlMaps_1 = htmlMaps; _i < htmlMaps_1.length; _i++) {
                var htmlMap = htmlMaps_1[_i];
                if (htmlMap) {
                    for (var propPath in htmlMap) {
                        var value = htmlMap[propPath];
                        if (typeof value === 'string') {
                            lodash.set(fixedProperties, propPath, value);
                        }
                    }
                }
            }
        }
        return fixedProperties;
    };
    BaseClientSideWebPart.prototype._forEachPropertyWithMetaData = function (callback, properties ) {
        if (this.propertiesMetadata) {
            for (var propPath in this.propertiesMetadata) {
                var metadata = this.propertiesMetadata[propPath];
                var wildcardCount = (propPath.match(/\*/g) || []).length;
                if (wildcardCount > 1) {
                    console.warn("Invalid property path: Multiple wildcards are not supported in property paths.\n Entry with path '" + propPath + "' got ignored in the properties metadata.");
                    continue;
                }
                else if (wildcardCount === 1) {
                    var index = propPath.indexOf('[*]');
                    if (index < -1) {
                        console.warn("Invalid property path: Wildcards are only supported inside brackets to select array\n indices as in 'foo[*].bar'. Entry with path '" + propPath + "' got ignored in the properties metadata.");
                        continue;
                    }
                    else {
                        var arrayPath = propPath.substr(0, index);
                        var arrayInstance = lodash.get(properties || this.properties, arrayPath);
                        if (!arrayInstance) {
                            console.warn("Invalid property path: Could not find an array named '" + arrayPath + "' in the properties.\n Entry with path '" + propPath + "' got ignored in the properties metadata.");
                            continue;
                        }
                        else {
                            for (var i = 0; i < arrayInstance.length; i++) {
                                var fixedPropPath = propPath.replace('*', "" + i);
                                callback(fixedPropPath, metadata);
                            }
                        }
                    }
                }
                else {
                    callback(propPath, metadata);
                }
            }
        }
    };
    BaseClientSideWebPart.prototype._deserialize = function (data) {
        return this._reInstateServerProcessedData(data.properties, data.serverProcessedContent);
    };
    BaseClientSideWebPart.prototype._internalInitialize = function (webPartContext) {
        sp_core_library_1.Validate.isNotNullOrUndefined(webPartContext, 'webPartContext');
        var context = webPartContext;
        this._processInputParams(context);
        sp_telemetry_1._TraceLogger.logVerbose(this._logSource, sp_core_library_1.Text.format(Strings_resx_1.default.ConstructLog, context.webPartTag));
        this._renderedOnce = false;
        this['__type'] = 'BaseClientSideWebPart';
        this.render = this.render.bind(this);
        this.onDispose = this.onDispose.bind(this);
        this.renderError = this.renderError.bind(this);
        this.clearError = this.clearError.bind(this);
        this.renderCompleted = this.renderCompleted.bind(this);
        this.onPropertyPaneRendered = this.onPropertyPaneRendered.bind(this);
        this._initialized = true;
    };
    BaseClientSideWebPart.prototype._internalDeserialize = function (data) {
        if (data) {
            if (data.title) {
                this._title = data.title;
            }
            if (data.description) {
                this._description = data.description;
            }
            if (typeof data.dataVersion !== 'string') {
                data.dataVersion = '1.0';
            }
            var deserializedData = {
                properties: data.properties,
                serverProcessedContent: data.serverProcessedContent,
                dataVersion: sp_core_library_1.Version.tryParse(data.dataVersion)
            };
            var deserializedPropsObject = this._deserialize(deserializedData);
            var fixedProps = this.onAfterDeserialize(deserializedPropsObject, deserializedData.dataVersion);
            if (!fixedProps) {
                throw SPWebPartError_1.SPWebPartError.create(SPWebPartError_1.SPWebPartErrorCode.OnAfterDeserializeReturnedNull, this.context.webPartTag);
            }
            this._properties = fixedProps;
        }
    };
    BaseClientSideWebPart.prototype._internalFirstTimeRender = function (addedFromPersistedData, mode, qosMonitor, data) {
        var _this = this;
        if (mode === void 0) { mode = sp_core_library_1.DisplayMode.Read; }
        if (this._renderPromiseResolver) {
            throw SPWebPartError_1.SPWebPartError.create(SPWebPartError_1.SPWebPartErrorCode.FirstTimeRenderCalledMoreThanOnce, this.context.webPartTag);
        }
        sp_telemetry_1._TraceLogger.logVerboseData({
            source: this._logSource,
            message: sp_core_library_1.Text.format(Strings_resx_1.default.StartedFirstTimeRender, this.context.webPartTag),
            serviceScope: this.context.serviceScope
        });
        return new Promise(function (resolve) {
            if (!_this._initialized && qosMonitor) {
                qosMonitor.writeUnexpectedFailure('BaseConstructorNotCalled');
                throw SPWebPartError_1.SPWebPartError.create(SPWebPartError_1.SPWebPartErrorCode.NotInitializedError, _this.context.webPartTag);
            }
            _this._displayMode = mode;
            _this._renderedFromPersistedData = addedFromPersistedData;
            if (!_this._renderedFromPersistedData) {
                var isInternal = _this.context.manifest.isInternal || false;
                var logEntry = new sp_telemetry_1._LogEntry(_this._logSource.id, 'WebPartAdded', sp_telemetry_1._LogType.Event, {
                    'alias': _this.context.manifest.alias,
                    'isInternal': isInternal.toString()
                });
                sp_telemetry_1._EngagementLogger.logEventWithLogEntry(logEntry);
            }
            if (data) {
                _this._internalDeserialize(data);
            }
            if (!_this._properties && qosMonitor) {
                qosMonitor.writeUnexpectedFailure('PropertyBagNull');
                throw SPWebPartError_1.SPWebPartError.create(SPWebPartError_1.SPWebPartErrorCode.PropertyBagNull, _this.context.webPartTag);
            }
            _this._renderPromiseResolver = resolve;
            if (sp_core_library_1._SPFlight.isEnabled(WEBPARTLOADINVIEWPORTFLIGHT) && !_this.context.host.isViewportLoadingDisabled) {
                sp_telemetry_1._PerformanceLogger.markComponent(_this.context.webPartTag, 'loadingDelayed');
                BaseClientSideWebPart._viewportLoader.register(_this);
            }
            else {
                _this._internalRenderInViewPort();
            }
        });
    };
    BaseClientSideWebPart.prototype._internalRenderInViewPort = function () {
        var _this = this;
        if (sp_core_library_1._SPFlight.isEnabled(WEBPARTLOADINVIEWPORTFLIGHT) && !this.context.host.isViewportLoadingDisabled) {
            sp_telemetry_1._PerformanceLogger.markComponent(this.context.webPartTag, 'inViewportLoading');
        }
        var promise = this.onInit();
        if (!promise) {
            throw SPWebPartError_1.SPWebPartError.create(SPWebPartError_1.SPWebPartErrorCode.OnInitReturnedNullPromise, this.context.webPartTag);
        }
        promise.then(function () {
            sp_telemetry_1._TraceLogger.logVerboseData({
                source: _this._logSource,
                message: sp_core_library_1.Text.format(Strings_resx_1.default.OnInitCompleted, _this.context.webPartTag),
                serviceScope: _this.context.serviceScope
            });
            sp_telemetry_1._PerformanceLogger.markComponent(_this.context.webPartTag, 'init');
            _this.context.statusRenderer.clearLoadingIndicator(_this.domElement);
            _this._renderWithAccessibileTitle();
            _this._renderedOnce = true;
            if (!_this.isRenderAsync) {
                sp_telemetry_1._PerformanceLogger.endMarkForComponent(_this.context.webPartTag);
                _this._resolveOnRenderPromise();
            }
            else {
                sp_telemetry_1._PerformanceLogger.markComponent(_this.context.webPartTag, 'asyncRenderStart');
                _this._startAsyncRenderGuardTimer();
            }
        });
    };
    BaseClientSideWebPart.prototype._internalSetDisplayMode = function (newDisplayMode) {
        if (this._displayMode !== newDisplayMode) {
            var oldDisplayMode = this._displayMode;
            this._displayMode = newDisplayMode;
            this.onDisplayModeChanged(oldDisplayMode);
        }
    };
    BaseClientSideWebPart.prototype._internalGetPropertyPaneData = function () {
        if (!this._propertiesBackup) {
            this._propertiesBackup = lodash.cloneDeep(this.properties);
        }
        var configuration = this.getPropertyPaneConfiguration();
        return {
            webPartId: this.context.instanceId,
            title: this.title,
            isReactive: !this.disableReactivePropertyChanges,
            configuration: configuration,
            properties: lodash.cloneDeep(this.properties),
            onPropertyPaneFieldChanged: undefined,
            onConfigurationEvent: undefined,
            onRendered: this.onPropertyPaneRendered
        };
    };
    BaseClientSideWebPart.prototype._internalOnPropertyPaneFieldChanged = function (propertyPath, newValue) {
        var oldValue = lodash.get(this._properties, propertyPath); 
        this._updateProperty(propertyPath, newValue);
        if (this.context.host.setDirty) {
            this.context.host.setDirty(this.context.instanceId);
        }
        this.onPropertyPaneFieldChanged(propertyPath, oldValue, newValue);
    };
    BaseClientSideWebPart.prototype._internalOnConfigurationEvent = function (configurationEvent) {
        switch (configurationEvent) {
            case PropertyPaneDefinitions_1.WebPartConfigurationEvent.PropertyPaneConfigurationStart:
                this.onPropertyPaneConfigurationStart();
                break;
            case PropertyPaneDefinitions_1.WebPartConfigurationEvent.PropertyPaneConfigurationComplete:
                this.onPropertyPaneConfigurationComplete();
                break;
            case PropertyPaneDefinitions_1.WebPartConfigurationEvent.PropertyPaneApplyClicked:
                if (this.disableReactivePropertyChanges) {
                    this.render();
                }
                this._propertiesBackup = undefined;
                this.onAfterPropertyPaneChangesApplied();
                break;
        }
    };
    BaseClientSideWebPart.prototype._internalSetDirtyBit = function () {
        if (this.displayMode === sp_core_library_1.DisplayMode.Read) {
            return;
        }
        var serializedState = this._internalSerialize();
        var newState = JSON.stringify(serializedState);
        if (!this._previousState) {
            this._previousState = newState;
        }
        else if (this._previousState !== newState && this.context.host.setDirty) {
            this.context.host.setDirty(this.context.instanceId, serializedState);
            this._previousState = newState;
        }
    };
    BaseClientSideWebPart.prototype._serialize = function () {
        var serverProcessedContent = {
            htmlStrings: {},
            imageSources: {},
            links: {}
        };
        var properties = lodash.cloneDeep(this.properties);
        this._forEachPropertyWithMetaData(function (propPath, metadata) {
            var key = propPath;
            var value = lodash.get(properties, propPath);
            if (serverProcessedContent && typeof value === 'string' && value !== undefined) {
                if (serverProcessedContent.htmlStrings && metadata.isHtmlString) {
                    serverProcessedContent.htmlStrings[key] = value;
                }
                else if (serverProcessedContent.links && metadata.isLink) {
                    serverProcessedContent.links[key] = value;
                }
                else if (serverProcessedContent.imageSources && metadata.isImageSource) {
                    serverProcessedContent.imageSources[key] = value;
                }
                lodash.set(properties, propPath, undefined);
            }
        });
        return {
            dataVersion: this.dataVersion,
            properties: properties,
            serverProcessedContent: serverProcessedContent
        };
    };
    BaseClientSideWebPart.prototype._internalSerialize = function () {
        var _this = this;
        var data; 
        ExecuteAndReThrow_1.executeAndReThrow(function () {
            _this.onBeforeSerialize();
            var serializedData = _this._serialize();
            sp_core_library_1.Validate.isNotNullOrUndefined(serializedData.dataVersion, 'serialized data version');
            data = {
                id: _this.context.manifest.id,
                instanceId: _this.context.instanceId,
                title: _this.title,
                description: _this.description,
                serverProcessedContent: serializedData.serverProcessedContent,
                dataVersion: serializedData.dataVersion.toString(),
                properties: serializedData.properties
            };
        }, SPWebPartError_1.SPWebPartError.create(SPWebPartError_1.SPWebPartErrorCode.SerializationFailed, this.context.webPartTag), this._logSource);
        return data;
    };
    BaseClientSideWebPart.prototype._internalDispose = function () {
        this.onDispose();
        sp_telemetry_1._TraceLogger.logVerbose(this._logSource, sp_core_library_1.Text.format(Strings_resx_1.default.DisposeLog, this.context.webPartTag));
    };
    BaseClientSideWebPart.prototype._internalOnAfterResize = function () {
        this.onAfterResize(this.width);
    };
    BaseClientSideWebPart.prototype._updateProperty = function (propertyPath, newValue) {
        lodash.update(this.properties, propertyPath, function () { return newValue; });
    };
    BaseClientSideWebPart.prototype._processInputParams = function (context) {
        sp_core_library_1.Validate.isNotNullOrUndefined(context, 'webpart context');
        sp_core_library_1.Validate.isNotNullOrUndefined(context.domElement, 'webpart element');
        sp_core_library_1.Validate.isNotNullOrUndefined(context.instanceId, 'webpart instanceId');
        sp_core_library_1.Validate.isNotNullOrUndefined(context.manifest, 'webpart manifest');
        sp_core_library_1.Validate.isNotNullOrUndefined(context.webPartTag, 'webpart tag');
        sp_core_library_1.Validate.isNotNullOrUndefined(context.spHttpClient, 'webpart spHttpClient');
        sp_core_library_1.Validate.isNotNullOrUndefined(context.httpClient, 'webpart httpClient');
        sp_core_library_1.Validate.isNotNullOrUndefined(context.pageContext, 'webpart context pageContext');
        sp_core_library_1.Validate.isNotNullOrUndefined(context.eventAggregator, 'webpart context eventAggregator');
        sp_core_library_1.Validate.isNotNullOrUndefined(context.statusRenderer, 'webpart context statusRenderer');
        sp_core_library_1.Validate.isNotNullOrUndefined(context.propertyPane, 'webpart context propertyPane');
        sp_core_library_1.Validate.isNotNullOrUndefined(context.host, 'webpart host');
        sp_core_library_1.Validate.isNotNullOrUndefined(context.serviceScope, 'webpart service scope');
        Object_1.deepFreeze(context.manifest);
        this._context = context;
        this._logEntry = 'BaseClientSideWebPart';
    };
    BaseClientSideWebPart.prototype._throwReadOnlyError = function () {
        throw SPWebPartError_1.SPWebPartError.create(SPWebPartError_1.SPWebPartErrorCode.ReadOnlyProperty);
    };
    BaseClientSideWebPart.prototype._renderWithAccessibileTitle = function () {
        this.render();
        var accessibleContext = this.accessibleTitle || this._getDefaultAccessibleTitle();
        if (accessibleContext) {
            var contextualLabelId = "cswpAccessibleLabelContextual_" + this.context.instanceId;
            var accessibleDiv = this.domElement.querySelector("#" + contextualLabelId);
            var isNewLabelElement = !accessibleDiv;
            if (isNewLabelElement) {
                accessibleDiv = document.createElement('div');
                accessibleDiv.id = contextualLabelId;
                accessibleDiv.className = cswp_base_module_scss_1.default.screenReaderOnly;
            }
            accessibleDiv.textContent = accessibleContext;
            if (isNewLabelElement) {
                this.domElement.appendChild(accessibleDiv);
            }
            ClassicPageUtils_1.default.disableAutomaticPostbacks(this.domElement, sp_core_library_1.Environment.type);
        }
    };
    BaseClientSideWebPart.prototype._getDefaultAccessibleTitle = function () {
        return sp_core_library_1.Text.format(Strings_resx_1.default.GenericAccessibleLabelTemplate, this.title);
    };
    BaseClientSideWebPart.prototype._startAsyncRenderGuardTimer = function () {
        var _this = this;
        this._clearAsyncRenderGuardTimer();
        this._asyncRenderQosMonitor = new sp_telemetry_1._QosMonitor("WebPartAsyncRender");
        this._asyncRenderGuardTimer = window.setTimeout(function () {
            _this._asyncRenderTimeout();
        }, 25000);
    };
    BaseClientSideWebPart.prototype._renderCompleted = function () {
        if (this._asyncRenderGuardTimer) {
            this._clearAsyncRenderGuardTimer();
            this._asyncRenderQosMonitor.writeSuccess({
                'alias': this.context.manifest.alias,
                'webPartId': this.context.manifest.id
            });
            sp_telemetry_1._TraceLogger.logVerboseData({
                source: this._logSource,
                message: sp_core_library_1.Text.format(Strings_resx_1.default.CompletedAsyncRender, this.context.webPartTag),
                serviceScope: this.context.serviceScope
            });
            this._resolveOnRenderPromise();
        }
        else {
            sp_telemetry_1._TraceLogger.logVerboseData({
                source: this._logSource,
                message: sp_core_library_1.Text.format(Strings_resx_1.default.CompletedAsyncRender, this.context.webPartTag),
                serviceScope: this.context.serviceScope
            });
        }
    };
    BaseClientSideWebPart.prototype._asyncRenderTimeout = function () {
        if (this._asyncRenderGuardTimer) {
            this._clearAsyncRenderGuardTimer();
            var error = SPWebPartError_1.SPWebPartError.create(SPWebPartError_1.SPWebPartErrorCode.RenderCompletedCallNotCalled, this.context.webPartTag);
            sp_telemetry_1._TraceLogger.logErrorData({
                source: this._logSource,
                error: error,
                serviceScope: this.context.serviceScope
            });
            this._asyncRenderQosMonitor.writeUnexpectedFailure('Timeout', error, {
                'alias': this.context.manifest.alias,
                'webPartId': this.context.manifest.id,
                'instanceId': this.instanceId
            });
            ClassicPageUtils_1.default.disableAutomaticPostbacks(this.domElement, sp_core_library_1.Environment.type);
            this._resolveOnRenderPromise();
        }
    };
    BaseClientSideWebPart.prototype._clearAsyncRenderGuardTimer = function () {
        if (this._asyncRenderGuardTimer) {
            window.clearTimeout(this._asyncRenderGuardTimer);
            this._asyncRenderGuardTimer = undefined;
        }
    };
    BaseClientSideWebPart.prototype._resolveOnRenderPromise = function () {
        if (this._renderPromiseResolver) {
            this._renderPromiseResolver();
        }
        this._renderPromiseResolver = undefined;
    };
    return BaseClientSideWebPart;
}());
BaseClientSideWebPart._viewportLoader = new ViewportLoader_1.default();
__decorate([
    decorators_1.virtual
], BaseClientSideWebPart.prototype, "propertiesMetadata", null);
__decorate([
    decorators_1.virtual
], BaseClientSideWebPart.prototype, "disableReactivePropertyChanges", null);
__decorate([
    decorators_1.virtual
], BaseClientSideWebPart.prototype, "previewImageUrl", null);
__decorate([
    decorators_1.virtual
], BaseClientSideWebPart.prototype, "accessibleTitle", null);
__decorate([
    decorators_1.virtual
], BaseClientSideWebPart.prototype, "isRenderAsync", null);
__decorate([
    decorators_1.virtual
], BaseClientSideWebPart.prototype, "onInit", null);
__decorate([
    decorators_1.virtual
], BaseClientSideWebPart.prototype, "onDisplayModeChanged", null);
__decorate([
    decorators_1.virtual
], BaseClientSideWebPart.prototype, "onBeforeSerialize", null);
__decorate([
    decorators_1.virtual
], BaseClientSideWebPart.prototype, "onAfterDeserialize", null);
__decorate([
    decorators_1.virtual
], BaseClientSideWebPart.prototype, "getPropertyPaneConfiguration", null);
__decorate([
    decorators_1.virtual
], BaseClientSideWebPart.prototype, "onDispose", null);
__decorate([
    decorators_1.virtual
], BaseClientSideWebPart.prototype, "onPropertyPaneFieldChanged", null);
__decorate([
    decorators_1.virtual
], BaseClientSideWebPart.prototype, "onPropertyPaneConfigurationStart", null);
__decorate([
    decorators_1.virtual
], BaseClientSideWebPart.prototype, "onPropertyPaneConfigurationComplete", null);
__decorate([
    decorators_1.virtual
], BaseClientSideWebPart.prototype, "onAfterPropertyPaneChangesApplied", null);
__decorate([
    decorators_1.virtual
], BaseClientSideWebPart.prototype, "onPropertyPaneRendered", null);
__decorate([
    decorators_1.virtual
], BaseClientSideWebPart.prototype, "onAfterResize", null);
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = BaseClientSideWebPart;
