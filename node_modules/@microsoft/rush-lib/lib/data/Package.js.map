{"version":3,"sources":["data/Package.ts"],"names":[],"mappings":"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","file":"data/Package.js","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport * as path from 'path';\r\n\r\nexport enum PackageDependencyKind {\r\n  Normal,\r\n  /**\r\n   * The dependency was listed in the optionalDependencies section of package.json.\r\n   */\r\n  Optional,\r\n\r\n  /**\r\n   * The dependency should be a symlink to a project that is locally built by Rush..\r\n   */\r\n  LocalLink\r\n}\r\n\r\nexport interface IPackageDependency {\r\n  /**\r\n   * The name of the dependency\r\n   */\r\n  name: string;\r\n  /**\r\n   * The requested version, which may be a pattern such as \"^1.2.3\"\r\n   */\r\n  versionRange: string;\r\n\r\n  /**\r\n   * The kind of dependency\r\n   */\r\n  kind: PackageDependencyKind;\r\n}\r\n\r\nexport interface IPackageJson extends PackageJson {\r\n  /**\r\n   * An extra setting written into package.json for temp packages, to track\r\n   * references to locally built projects.\r\n   */\r\n  rushDependencies?: { [key: string]: string };\r\n}\r\n\r\nexport default class Package {\r\n  /**\r\n   * The \"name\" field from package.json\r\n   */\r\n  public name: string;\r\n\r\n  /**\r\n   * The \"version\" field from package.json\r\n   */\r\n  public version: string;\r\n\r\n  /**\r\n   * Names of packages that we explicitly depend on.  The actual dependency\r\n   * package may be found in this.children, or possibly in this.children of\r\n   * one of the parents.\r\n   * If a dependency is listed in the \"optionalDependencies\" section of package.json\r\n   * then its name here will be prepended with a \"?\" character, which means that Rush\r\n   * will not report an error if the module cannot be found in the Common folder.\r\n   */\r\n  public dependencies: IPackageDependency[];\r\n\r\n  /**\r\n   * The absolute path to the folder that contains package.json.\r\n   */\r\n  public folderPath: string;\r\n\r\n  /**\r\n   * The parent package, or undefined if this is the root of the tree.\r\n   */\r\n  public parent: Package;\r\n\r\n  /**\r\n   * If this is a local path that we are planning to symlink to a target folder,\r\n   * then symlinkTargetFolderPath keeps track of the intended target.\r\n   */\r\n  public symlinkTargetFolderPath: string = undefined;\r\n\r\n  /**\r\n   * If this was loaded using createFromNpm(), then the parsed package.json is stored here.\r\n   */\r\n  public originalPackageJson: PackageJson = undefined;\r\n\r\n  /**\r\n   * Packages that were placed in node_modules subfolders of this package.\r\n   * The child packages are not necessarily dependencies of this package.\r\n   */\r\n  public children: Package[];\r\n  private _childrenByName: Map<string, Package>;\r\n\r\n  /**\r\n   * Recursive constructs a tree of Package objects using information returned\r\n   * by the \"read-package-tree\" library.\r\n   */\r\n  public static createFromNpm(npmPackage: PackageNode): Package {\r\n    if (npmPackage.error) {\r\n      throw Error(`Failed to parse package.json for ${path.basename(npmPackage.path)}: `\r\n        + npmPackage.error.message);\r\n    }\r\n\r\n    let dependencies: IPackageDependency[] = [];\r\n    const dependencyNames: Set<string> = new Set<string>();\r\n    const packageJson: IPackageJson = npmPackage.package;\r\n\r\n    if (packageJson.optionalDependencies) {\r\n      for (const dependencyName of Object.keys(packageJson.optionalDependencies)) {\r\n        if (!dependencyNames.has(dependencyName)) {\r\n          dependencyNames.add(dependencyName);\r\n          dependencies.push({\r\n            name: dependencyName,\r\n            versionRange: packageJson.optionalDependencies[dependencyName],\r\n            kind: PackageDependencyKind.Optional\r\n          });\r\n        }\r\n      }\r\n    }\r\n    if (packageJson.dependencies) {\r\n      for (const dependencyName of Object.keys(packageJson.dependencies)) {\r\n        if (!dependencyNames.has(dependencyName)) {\r\n          dependencyNames.add(dependencyName);\r\n          dependencies.push({\r\n            name: dependencyName,\r\n            versionRange: packageJson.dependencies[dependencyName],\r\n            kind: PackageDependencyKind.Normal\r\n          });\r\n        }\r\n      }\r\n    }\r\n    if (packageJson.rushDependencies) {\r\n      for (const dependencyName of Object.keys(packageJson.rushDependencies)) {\r\n        if (!dependencyNames.has(dependencyName)) {\r\n          dependencyNames.add(dependencyName);\r\n          dependencies.push({\r\n            name: dependencyName,\r\n            versionRange: packageJson.dependencies[dependencyName],\r\n            kind: PackageDependencyKind.LocalLink\r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    dependencies = dependencies.sort((a, b) => a.name.localeCompare(b.name));\r\n\r\n    const newPackage: Package = new Package(\r\n      npmPackage.package.name,\r\n      npmPackage.package.version,\r\n      dependencies,\r\n      // NOTE: We don't use packageNode.realpath here, because if \"npm unlink\" was\r\n      // performed without redoing \"rush link\", then a broken symlink is better than\r\n      // a symlink to the wrong thing.\r\n      npmPackage.path\r\n    );\r\n\r\n    newPackage.originalPackageJson = packageJson;\r\n\r\n    for (const child of npmPackage.children) {\r\n      newPackage.addChild(Package.createFromNpm(child));\r\n    }\r\n\r\n    return newPackage;\r\n  }\r\n\r\n  constructor(name: string, version: string, dependencies: IPackageDependency[], folderPath: string) {\r\n\r\n    this.name = name;\r\n    this.version = version;\r\n    this.dependencies = dependencies.slice(0); // clone the array\r\n    this.folderPath = folderPath;\r\n    this.parent = undefined;\r\n    this.children = [];\r\n    this._childrenByName = new Map<string, Package>();\r\n  }\r\n\r\n  public get nameAndVersion(): string {\r\n    let result: string = '';\r\n\r\n    if (this.name) {\r\n      result += this.name;\r\n    } else {\r\n      result += '(missing name)';\r\n    }\r\n    result += '@';\r\n    if (this.version) {\r\n      result += this.version;\r\n    } else {\r\n      result += '(missing version)';\r\n    }\r\n    return result;\r\n  }\r\n\r\n  public addChild(child: Package): void {\r\n    if (child.parent) {\r\n      throw Error('Child already has a parent');\r\n    }\r\n    if (this._childrenByName.has(child.name)) {\r\n      throw Error('Child already exists');\r\n    }\r\n    child.parent = this;\r\n    this.children.push(child);\r\n    this._childrenByName.set(child.name, child);\r\n  }\r\n\r\n  public getChildByName(childPackageName: string): Package {\r\n    return this._childrenByName.get(childPackageName);\r\n  }\r\n\r\n  /**\r\n   * Searches the node_modules hierarchy for the nearest matching package with the\r\n   * given name.  Note that the nearest match may have an incompatible version.\r\n   * If a match is found, then the \"found\" result will not be undefined.\r\n   * In either case, the parentForCreate result indicates where the missing\r\n   * dependency can be added, i.e. if the requested dependency was not found\r\n   * or was found with an incompatible version.\r\n   *\r\n   * \"cyclicSubtreeRoot\" is a special optional parameter that specifies a different\r\n   * root for the tree; the cyclicDependencyProjects feature uses this to isolate\r\n   * certain devDependencies in their own subtree.\r\n   */\r\n  public resolveOrCreate(dependencyName: string, cyclicSubtreeRoot?: Package): IResolveOrCreateResult {\r\n\r\n    let currentParent: Package = this;\r\n    let parentForCreate: Package = undefined;\r\n\r\n    // tslint:disable-next-line:no-constant-condition\r\n    while (true) {\r\n      // Does any child match?\r\n      for (const child of currentParent.children) {\r\n        if (child.name === dependencyName) {\r\n          // One of the children matched.  Note that parentForCreate may be\r\n          // undefined, e.g. if an immediate child is found but has the wrong version,\r\n          // then we have no place in the tree to create another version.\r\n          return { found: child, parentForCreate };\r\n        }\r\n      }\r\n\r\n      // If no child matched, then make this node the \"parentForCreate\" where we\r\n      // could add a missing dependency.\r\n      parentForCreate = currentParent;\r\n\r\n      if (!currentParent.parent\r\n        || (cyclicSubtreeRoot && currentParent === cyclicSubtreeRoot)) {\r\n        // We reached the root without finding a match\r\n        // parentForCreate will be the root.\r\n        return { found: undefined, parentForCreate };\r\n      }\r\n\r\n      // Continue walking upwards.\r\n      currentParent = currentParent.parent;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Searches the node_modules hierarchy for the nearest matching package with the\r\n   * given name.  If no match is found, then undefined is returned.\r\n   */\r\n  public resolve(dependencyName: string): Package {\r\n    return this.resolveOrCreate(dependencyName).found;\r\n  }\r\n\r\n  public printTree(indent?: string): void {\r\n    if (!indent) {\r\n      indent = '';\r\n    }\r\n    console.log(indent + this.nameAndVersion);\r\n    for (const child of this.children) {\r\n      child.printTree(indent + '  ');\r\n    }\r\n  }\r\n}\r\n\r\nexport interface IResolveOrCreateResult {\r\n  found: Package;\r\n  parentForCreate: Package;\r\n}\r\n"],"sourceRoot":"..\\..\\src"}