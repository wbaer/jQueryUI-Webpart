/**
 * @file DualTaskStream.ts
 * @Copyright (c) Microsoft Corporation.  All rights reserved.
 *
 * This is a special type of stream class which has two substreams (stderr and stdout), which you can write to.
 */
/* istanbul ignore next */
"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var colors = require('colors');
var stream = require('stream');
var PersistentStream_1 = require('./PersistentStream');
/**
 * This is a special type of stream class which has two substreams (stderr and stdout), which you can write to.
 * The DualTaskStream will merge these two streams into a single readable stream.
 * Everything written to stderr is written in red, unless it is a Warning, in which case it appears in yellow.
 */
var DualTaskStream = (function (_super) {
    __extends(DualTaskStream, _super);
    /**
     * @param {boolean} quietMode is true if things written to stdout (and warnings) should be ignored
     */
    function DualTaskStream(quietMode) {
        var _this = this;
        if (quietMode === void 0) { quietMode = false; }
        _super.call(this);
        this._quietMode = quietMode;
        this.stdout = new PersistentStream_1.default();
        this.stderr = new PersistentStream_1.default();
        this.stdout.on('finish', function () {
            _this._stdoutClosed = true;
        });
        this.stderr.on('finish', function () {
            _this._stderrClosed = true;
        });
        this.stdout.on('data', function (data, encoding) {
            if (!_this._quietMode) {
                _this.push(data);
            }
        });
        this.stderr.on('data', function (data, encoding) {
            var text = data.toString();
            if (text.indexOf('Warning - ') === 0) {
                _this.stdout.write(colors.yellow(text));
            }
            else {
                _this.push(colors.red(text));
            }
        });
    }
    DualTaskStream.prototype._read = function () {
        // No-op
    };
    /**
     * Closes both substreams and closes the readable stream
     */
    DualTaskStream.prototype.end = function () {
        if (!this._stdoutClosed) {
            this.stdout.end();
        }
        if (!this._stderrClosed) {
            this.stderr.end();
        }
        // End the stream
        if (!this._closed) {
            this._closed = true;
            this.push(null); // tslint:disable-line:no-null-keyword
        }
    };
    return DualTaskStream;
}(stream.Readable));
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = DualTaskStream;

//# sourceMappingURL=DualTaskStream.js.map
