{"version":3,"sources":["configureWebpack/ExternalsProcessor.ts"],"names":[],"mappings":"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","file":"configureWebpack/ExternalsProcessor.js","sourcesContent":["import * as path from 'path';\r\n\r\nimport CumulativeManifestProcessor, {\r\n  IReferencedProject,\r\n  IReferencedProjectMap,\r\n  ForceSearch\r\n} from './../writeManifests/cumulativeManifest/cumulativeManifestProcessor';\r\nimport OdspGulpTask from './../OdspGulpTask';\r\nimport { resolvePackage } from './../utilities/Resolve';\r\n\r\nexport interface IExternalProjectMap {\r\n  [name: string]: IExternalProject;\r\n}\r\n\r\ninterface IFailoverExternalProject extends IExternalProject {\r\n  /**\r\n   * A function to get the failover path given the package's root.\r\n   */\r\n  getFailoverPath?: (packageRoot: string) => string;\r\n}\r\n\r\nexport interface IExternalProject {\r\n  /**\r\n   * The ID of the project from the manifest.\r\n   */\r\n  id: string;\r\n\r\n  /**\r\n   * The name of the project.\r\n   */\r\n  name: string;\r\n\r\n  /**\r\n   * The version of the project from the manifest.\r\n   */\r\n  version: string;\r\n\r\n  /**\r\n   * The failover path, if one exists.\r\n   */\r\n  failoverPath?: string;\r\n}\r\n\r\n/**\r\n * Get an array of a project's externals' names. To be used when creating a webpack configuration.\r\n */\r\n// tslint:disable-next-line:no-any\r\nexport function getExternalsKeys(gulpTask: OdspGulpTask<any>): string[] {\r\n  // Set the linked externals if they aren't already set\r\n  setLinkedExternals(gulpTask);\r\n\r\n  const result: string[] = [];\r\n\r\n  result.push(...Object.keys(gulpTask.properties.linkedExternals));\r\n\r\n  if (gulpTask.properties.externals) {\r\n    result.push(...Object.keys(gulpTask.properties.externals));\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\n/**\r\n * Set the linked externals in the task's shared properties object if it isn't already set\r\n */\r\n// tslint:disable-next-line:no-any\r\nexport function setLinkedExternals(gulpTask: OdspGulpTask<any>): void {\r\n  if (!gulpTask.properties.linkedExternals) {\r\n    const linkedExternals: IExternalProjectMap = getLinkedExternals(gulpTask);\r\n    gulpTask.properties.linkedExternals = linkedExternals;\r\n  }\r\n}\r\n\r\n/**\r\n * Gets the referenced externals for a project.\r\n */\r\n// tslint:disable-next-line:no-any\r\nfunction getLinkedExternals(gulpTask: OdspGulpTask<any>): IExternalProjectMap {\r\n  // Discover packages that should be externalized because they have manifests\r\n  const cumulativeManifestProcessor: CumulativeManifestProcessor = new CumulativeManifestProcessor(gulpTask);\r\n  const discoveredManifests: IReferencedProjectMap =\r\n    cumulativeManifestProcessor.discoverManifests(process.cwd(), ForceSearch.deepSparseIgnoreFirstProject);\r\n\r\n  const result: IExternalProjectMap = {};\r\n\r\n  // Add these projects to externalized packages\r\n  for (const manifestId in discoveredManifests) {\r\n    const referencedProject: IReferencedProject = discoveredManifests[manifestId];\r\n    if (referencedProject.packageName) {\r\n      result[referencedProject.packageName] = {\r\n        id: manifestId,\r\n        name: referencedProject.packageName,\r\n        version: referencedProject.manifestData.version\r\n      };\r\n    }\r\n  }\r\n\r\n  const nonStandardExternals: IExternalProjectMap = _getNonStandardExternals(gulpTask.buildConfig.rootPath);\r\n  for (const externalName in nonStandardExternals) {\r\n    result[externalName] = nonStandardExternals[externalName];\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\nconst _nonStandardExternalMap: { [name: string]: IFailoverExternalProject } = {\r\n  'react': {\r\n    name: 'react',\r\n    version: '15.4.2',\r\n    id: '0d910c1c-13b9-4e1c-9aa4-b008c5e42d7d',\r\n    getFailoverPath: (packageRoot: string) => path.join(packageRoot, 'dist', 'react.js')\r\n  },\r\n\r\n  'react-dom': {\r\n    name: 'react-dom',\r\n    version: '15.4.2',\r\n    id: 'aa0a46ec-1505-43cd-a44a-93f3a5aa460a',\r\n    getFailoverPath: (packageRoot: string) => path.join(packageRoot, 'dist', 'react-dom.js')\r\n  },\r\n\r\n  'office-ui-fabric-react': {\r\n    name: 'office-ui-fabric-react',\r\n    version: '1.0.0',\r\n    id: '02a01e42-69ab-403d-8a16-acd128661f8e'\r\n  }\r\n};\r\n\r\n/**\r\n * This is a temporary function that will soon be replaced by something more robust. It\r\n *  currently serves to include linked externals referenced in projects that don't have manifests.\r\n */\r\nfunction _getNonStandardExternals(projectRootPath: string): IExternalProjectMap {\r\n  const result: IExternalProjectMap = {};\r\n\r\n  for (const dependency in _nonStandardExternalMap) {\r\n    tryFillFailoverPath(projectRootPath, _nonStandardExternalMap[dependency]);\r\n    result[dependency] = _nonStandardExternalMap[dependency];\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\nfunction tryFillFailoverPath(projectRootPath: string, dependency: IFailoverExternalProject): void {\r\n  if (!dependency.failoverPath && dependency.getFailoverPath) {\r\n    try {\r\n      const resolvedPath: string = resolvePackage(dependency.name, projectRootPath);\r\n      dependency.failoverPath = dependency.getFailoverPath(resolvedPath);\r\n    } catch (e) { /* empty */ }\r\n  }\r\n}\r\n"],"sourceRoot":"..\\..\\src"}