"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var React = require("react");
var TraceList_module_scss_1 = require("./TraceList.module.scss");
var TraceDisplayStore_1 = require("../../../../Stores/TraceDisplayStore");
var TraceListHeader_1 = require("./TraceListHeader/TraceListHeader");
var TraceListItem_1 = require("./TraceListItem/TraceListItem");
var TraceDisplay_resx_1 = require("./../TraceDisplay.resx");
var TraceList = (function (_super) {
    __extends(TraceList, _super);
    function TraceList(props) {
        var _this = _super.call(this, props) || this;
        _this._exportAsCSV = _this._exportAsCSV.bind(_this);
        return _this;
    }
    TraceList.prototype.render = function () {
        var _this = this;
        var idCounter = 0;
        var displayedTraces = [];
        var levelFilters = this.props.filters.level;
        var scopeFilters = this.props.filters.scope;
        var sourceFilters = this.props.filters.source;
        if (!this.props.allTraces) {
            return React.createElement("div", null,
                React.createElement(TraceListHeader_1.default, { filters: this.props.filters }),
                TraceDisplay_resx_1.default.EmptyTraceData);
        }
        this.props.allTraces.forEach(function (trace) {
            if (levelFilters[TraceDisplayStore_1.LogLevel[trace.level]] === false) {
                return;
            }
            if (trace.scope) {
                _this._addFilterLabel(trace.scope.id, scopeFilters);
                if (!scopeFilters[trace.scope.id]) {
                    return;
                }
            }
            else if (scopeFilters.none === false) {
                return;
            }
            if (trace.source) {
                _this._addFilterLabel(trace.source, sourceFilters);
                if (!sourceFilters[trace.source]) {
                    return;
                }
            }
            displayedTraces.push(React.createElement(TraceListItem_1.default, { key: idCounter, id: idCounter, trace: trace }));
            idCounter++;
        });
        return (React.createElement("div", { className: TraceList_module_scss_1.default.container },
            React.createElement("button", { onClick: this._exportAsCSV }, TraceDisplay_resx_1.default.ExportCSVButtonLabel),
            React.createElement(TraceListHeader_1.default, { filters: this.props.filters }),
            React.createElement("ul", { className: TraceList_module_scss_1.default.traceListItemsContainer }, displayedTraces)));
    };
    TraceList.prototype._addFilterLabel = function (filterLabel, multiFilter) {
        if (filterLabel && !(filterLabel in multiFilter)) {
            multiFilter[filterLabel] = true;
        }
    };
    TraceList.prototype._exportAsCSV = function () {
        var tracesLength = this.props.allTraces.length;
        if (tracesLength === 0) {
            return;
        }
        var header = 'data:text/csv;charset=utf-8,Timestamp,Level,Source,Message\n';
        var items = this.props.allTraces.map(this._logEventToCSV);
        var csvContent = header + items.join('\n');
        var link = document.createElement('a');
        link.setAttribute('href', encodeURI(csvContent));
        link.setAttribute('download', 'spfx_trace_logs.csv');
        document.body.appendChild(link);
        link.click(); 
        document.body.removeChild(link);
    };
    TraceList.prototype._logEventToCSV = function (logEvent) {
        var logEventArray = [];
        logEventArray.push(String(logEvent.timestamp));
        logEventArray.push(logEvent.level ? TraceDisplayStore_1.LogLevel[logEvent.level] : ' '); 
        logEventArray.push(logEvent.source);
        if (logEvent.message) {
            logEventArray.push(logEvent.message);
        }
        else if (logEvent.error) {
            logEventArray.push(logEvent.error.message);
        }
        return logEventArray.join(',');
    };
    return TraceList;
}(React.Component));
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = TraceList;
