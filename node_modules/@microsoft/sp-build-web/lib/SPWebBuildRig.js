"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var path = require("path");
var gulp_core_build_sass_1 = require("@microsoft/gulp-core-build-sass");
var gulp_core_build_serve_1 = require("@microsoft/gulp-core-build-serve");
var gulp_core_build_webpack_1 = require("@microsoft/gulp-core-build-webpack");
var gulp_core_build_karma_1 = require("@microsoft/gulp-core-build-karma");
var spBuildCoreTasks = require("@microsoft/sp-build-core-tasks");
var sp_build_common_1 = require("@microsoft/sp-build-common");
var WebBuildRigConstants_1 = require("./WebBuildRigConstants");
function getSchemaFilePath(filename) {
    return path.join(__dirname, 'schemas', filename);
}
var SPWebBuildRig = (function (_super) {
    __extends(SPWebBuildRig, _super);
    function SPWebBuildRig() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    SPWebBuildRig.prototype.initialize = function (gulp) {
        _super.prototype.initialize.call(this, gulp);
    };
    SPWebBuildRig.prototype.getYargs = function () {
        // tslint:disable:max-line-length
        return _super.prototype.getYargs.call(this)
            .option('debug', {
            describe: 'runs tests in unit mode'
        })
            .command(WebBuildRigConstants_1.WebBuildRigConstants.tasks.bundle, 'build, localize, and bundle the project')
            .command(WebBuildRigConstants_1.WebBuildRigConstants.tasks.deployAzureStorage, 'upload the assets to a development CDN')
            .command(WebBuildRigConstants_1.WebBuildRigConstants.tasks.packageSolution, 'package the project into a SPAPP')
            .command(WebBuildRigConstants_1.WebBuildRigConstants.tasks.test, 'build, localize, and bundle the project and run tests, and verify the coverage')
            .command(WebBuildRigConstants_1.WebBuildRigConstants.tasks.serve, 'build and bundle the project and run the development server')
            .command(WebBuildRigConstants_1.WebBuildRigConstants.tasks.devDeploy, 'deploy the current project to a development Azure CDN for sharing builds with colleagues.')
            .command(WebBuildRigConstants_1.WebBuildRigConstants.tasks.trustDevCert, 'generates and trusts a development certificate if one isn\'t already present')
            .command(WebBuildRigConstants_1.WebBuildRigConstants.tasks.untrustDevCert, 'untrusts and deletes the development certificate if it exists')
            .command('default', 'equivalent to bundle and test');
        // tslint:enable:max-line-length
    };
    SPWebBuildRig.prototype.setupSharedConfig = function () {
        _super.prototype.setupSharedConfig.call(this);
        gulp_core_build_sass_1.default.mergeConfig({
            dropCssFiles: true,
            warnOnNonCSSModules: true
        });
        gulp_core_build_karma_1.default.mergeConfig({
            configPath: path.resolve(path.join(__dirname, 'karma', 'karma.config.js'))
        });
        spBuildCoreTasks.configureWebpack.mergeConfig({
            webpack: gulp_core_build_webpack_1.default,
            configureExternalBundlingWebpackTask: spBuildCoreTasks.configureExternalBundlingWebpack
        });
        spBuildCoreTasks.configureExternalBundlingWebpack.mergeConfig({
            webpack: gulp_core_build_webpack_1.default,
            configureWebpackTask: spBuildCoreTasks.configureWebpack,
            debugLocale: this.args.locale
        });
        spBuildCoreTasks.writeManifests.mergeConfig({
            debugLocale: this.args.locale
        });
        if (this.args.production) {
            spBuildCoreTasks.copyAssets.mergeConfig({
                extsToIgnore: ['.map', '.stats.json', '.stats.html']
            });
        }
    };
    SPWebBuildRig.prototype.finalizeSharedConfig = function () {
        _super.prototype.finalizeSharedConfig.call(this);
        if (this.args.minimal) {
            this._disableTasks(gulp_core_build_karma_1.default, spBuildCoreTasks.casperJSRunner);
        }
        spBuildCoreTasks.writeManifests.mergeConfig({
            deployCdnPath: spBuildCoreTasks.copyAssets.taskConfig.deployCdnPath,
            debugBasePath: (gulp_core_build_serve_1.serve.taskConfig.https ? 'https' : 'http') + "://localhost:" + gulp_core_build_serve_1.serve.taskConfig.port + "/"
        });
        if (this.args.production) {
            spBuildCoreTasks.packageSolution.mergeConfig({
                paths: {
                    manifestDir: spBuildCoreTasks.copyAssets.taskConfig.deployCdnPath
                }
            });
        }
    };
    SPWebBuildRig.prototype.getTasks = function () {
        var result = _super.prototype.getTasks.call(this);
        result.set(sp_build_common_1.BuildRigConstants.tasks.build, {
            executable: this.getBuildTask()
        });
        result.set(WebBuildRigConstants_1.WebBuildRigConstants.tasks.bundle, {
            executable: this.getBundleTask()
        });
        result.set(WebBuildRigConstants_1.WebBuildRigConstants.tasks.devDeploy, {
            executable: spBuildCoreTasks.devDeploy,
            arguments: function (yargs) {
                return yargs
                    .option('rush', {
                    describe: 'use all projects specified in the repo\'s rush.json'
                });
            }
        });
        result.set(WebBuildRigConstants_1.WebBuildRigConstants.tasks.deployAzureStorage, {
            executable: spBuildCoreTasks.deployAzureStorage
        });
        result.set(WebBuildRigConstants_1.WebBuildRigConstants.tasks.packageSolution, {
            executable: spBuildCoreTasks.packageSolution
        });
        // @todo VSO #167343
        result.set(WebBuildRigConstants_1.WebBuildRigConstants.tasks.test, {
            executable: this.getTestTask(),
            arguments: function (yargs) {
                return yargs
                    .option('debug', {
                    describe: 'run tests in debug mode'
                })
                    .option('match', {
                    describe: 'regular expression. Only run tests that match',
                    string: true
                });
            }
        });
        result.set(WebBuildRigConstants_1.WebBuildRigConstants.tasks.serve, {
            executable: sp_build_common_1.serial(result.get(WebBuildRigConstants_1.WebBuildRigConstants.tasks.bundle).executable, gulp_core_build_serve_1.serve, sp_build_common_1.watch(['src/**/*.{ts,tsx,scss,resx,js,json,html}',
                '!src/**/*.{scss.ts,resx.ts}'], sp_build_common_1.serial(result.get(WebBuildRigConstants_1.WebBuildRigConstants.tasks.bundle).executable, gulp_core_build_serve_1.reload))),
            arguments: function (yargs) {
                return yargs
                    .option('port', {
                    description: 'the port to serve on should be the next argument (e.g. "--port 80")'
                })
                    .option('nobrowser', {
                    description: 'don\'t open a browser after initial bundle'
                });
            }
        });
        result.set(WebBuildRigConstants_1.WebBuildRigConstants.tasks.trustDevCert, {
            executable: gulp_core_build_serve_1.trustDevCert
        });
        result.set(WebBuildRigConstants_1.WebBuildRigConstants.tasks.untrustDevCert, {
            executable: gulp_core_build_serve_1.untrustDevCert
        });
        result.set(sp_build_common_1.BuildRigConstants.tasks.default, result.get(WebBuildRigConstants_1.WebBuildRigConstants.tasks.bundle));
        return result;
    };
    SPWebBuildRig.prototype.getTestTask = function () {
        return sp_build_common_1.serial(this.getBundleTask(), (WebBuildRigConstants_1.WebBuildRigConstants.flags.enableCasperTests
            ? sp_build_common_1.parallel(spBuildCoreTasks.casperJSRunner, gulp_core_build_karma_1.default)
            : gulp_core_build_karma_1.default));
    };
    SPWebBuildRig.prototype.getCoreBuildTask = function () {
        return sp_build_common_1.parallel(sp_build_common_1.serial(gulp_core_build_sass_1.default, _super.prototype.getCoreBuildTask.call(this)), spBuildCoreTasks.copyStaticAssets);
    };
    SPWebBuildRig.prototype.getBundleTask = function () {
        return sp_build_common_1.serial(this.getBuildTask(), spBuildCoreTasks.collectLocalizedResources, spBuildCoreTasks.configureWebpack, gulp_core_build_webpack_1.default, // First webpack instance to create the base bundle
        spBuildCoreTasks.configureExternalBundlingWebpack, 
        // Second webpack instance to optionally expand the base bundle. This task is disabled if
        //  configureExternalBundlingWebpack isn't configured to do anything
        gulp_core_build_webpack_1.default, spBuildCoreTasks.copyAssets, spBuildCoreTasks.writeManifests);
    };
    return SPWebBuildRig;
}(sp_build_common_1.SPBuildRig));
exports.SPWebBuildRig = SPWebBuildRig;

//# sourceMappingURL=SPWebBuildRig.js.map
