"use strict";
var chai_1 = require("chai");
var sp_core_library_1 = require("@microsoft/sp-core-library");
var test_1 = require("@microsoft/sp-core-library/lib/test");
var SPHttpClientBatch_1 = require("../SPHttpClientBatch");
var MockFetchProvider_1 = require("../../test/MockFetchProvider");
var FetchProvider_1 = require("../../httpClient/FetchProvider");
describe('SPHttpClientBatch tests', function () {
    describe('Main scenario', function () {
        var rootScope = sp_core_library_1.ServiceScope.startNewRoot();
        var fetchProvider = new MockFetchProvider_1.default(rootScope);
        rootScope.provide(FetchProvider_1.fetchProviderServiceKey, fetchProvider);
        var randomNumberGenerator = new test_1.MockRandomNumberGenerator(rootScope);
        rootScope.provide(sp_core_library_1.RandomNumberGenerator.serviceKey, randomNumberGenerator);
        rootScope.finish();
        it('should batch a single GET request', function (done) {
            fetchProvider.expect({
                expectedUrl: 'http://example.com/_api/contextinfo',
                responseObject: {
                    'FormDigestValue': 'DIGEST_1',
                    'FormDigestTimeoutSeconds': 30
                }
            });
            fetchProvider.expect({
                expectedUrl: 'http://example.com/_api/$batch',
                expectedRequestHeaders: [
                    new MockFetchProvider_1.MockedHeader('accept', 'application/json'),
                    new MockFetchProvider_1.MockedHeader('odata-version', '4.0'),
                    new MockFetchProvider_1.MockedHeader('content-type', 'multipart/mixed; boundary=batch_019ef386-4b18-49c9-8efb-f46eaef2de4e'),
                    new MockFetchProvider_1.MockedHeader('x-requestdigest', 'DIGEST_1')
                ],
                expectedRequestObject: "\n--batch_019ef386-4b18-49c9-8efb-f46eaef2de4e\nContent-type: application/http\nContent-Transfer-Encoding: binary\n\nGET http://example.com/_api/batch01 HTTP/1.1\naccept: application/json;odata.metadata=minimal\n\n\n\n--batch_019ef386-4b18-49c9-8efb-f46eaef2de4e--\n",
                responseHeaders: [
                    new MockFetchProvider_1.MockedHeader('Content-Type', 'multipart/mixed; boundary=batchresponse_8132cf43-7a45-4e72-828a-6f3a135b1f7e')
                ],
                responseContentLengthHeader: true,
                responseObject: "\n--batchresponse_8132cf43-7a45-4e72-828a-6f3a135b1f7e\nContent-Type: application/http\nContent-Transfer-Encoding: binary\n\nHTTP/1.1 200 OK\nCONTENT-TYPE: application/json;odata=minimalmetadata;streaming=true;charset=utf-8\n\n{\"data\":12345}\n--batchresponse_8132cf43-7a45-4e72-828a-6f3a135b1f7e--\n"
            });
            var spHttpClientBatch = new SPHttpClientBatch_1.default(rootScope, {});
            var fetchPromise = spHttpClientBatch.get('http://example.com/_api/batch01', SPHttpClientBatch_1.default.configurations.v1)
                .then(function (response) {
                return response.json();
            }).then(function (responseObject) {
                chai_1.assert.equal(responseObject.data, 12345);
            });
            var executePromise = spHttpClientBatch.execute()
                .then(function (batch) {
                return;
            });
            Promise.all([fetchPromise, executePromise])
                .then(function () {
                fetchProvider.assertQueueEmpty();
                done();
            })
                .catch(function (error) {
                done(error);
            });
        });
        it('should batch multiple requests including a failed request', function (done) {
            fetchProvider.expect({
                expectedUrl: 'http://example.com/_api/$batch',
                expectedRequestHeaders: [
                    new MockFetchProvider_1.MockedHeader('accept', 'application/json'),
                    new MockFetchProvider_1.MockedHeader('odata-version', '4.0'),
                    new MockFetchProvider_1.MockedHeader('content-type', 'multipart/mixed; boundary=batch_6486cb89-1969-4d7c-933c-1299b576ef92'),
                    new MockFetchProvider_1.MockedHeader('x-requestdigest', 'DIGEST_1')
                ],
                expectedRequestObject: "\n--batch_6486cb89-1969-4d7c-933c-1299b576ef92\nContent-type: application/http\nContent-Transfer-Encoding: binary\n\nGET http://example.com/_api/test1 HTTP/1.1\nmy-custom-header: header value\naccept: application/json;odata.metadata=minimal\n\n\n\n--batch_6486cb89-1969-4d7c-933c-1299b576ef92\nContent-type: application/http\nContent-Transfer-Encoding: binary\n\nPOST http://example.com/_api/test2 HTTP/1.1\ncontent-type: application/json;charset=utf-8\naccept: application/json;odata.metadata=minimal\n\nBODY2\n\n--batch_6486cb89-1969-4d7c-933c-1299b576ef92\nContent-type: application/http\nContent-Transfer-Encoding: binary\n\nGET http://example.com/_api/test3 HTTP/1.1\naccept: application/json;odata.metadata=minimal\n\n\n\n--batch_6486cb89-1969-4d7c-933c-1299b576ef92--\n",
                responseHeaders: [
                    new MockFetchProvider_1.MockedHeader('Content-Type', 'multipart/mixed; boundary=batchresponse_761bdf66-72c3-4938-a1f4-3baaf0a7f647')
                ],
                responseContentLengthHeader: true,
                responseObject: "\n--batchresponse_761bdf66-72c3-4938-a1f4-3baaf0a7f647\nContent-Type: application/http\nContent-Transfer-Encoding: binary\n\nHTTP/1.1 200 OK\nCONTENT-TYPE: application/json;odata=minimalmetadata;streaming=true;charset=utf-8\n\n\"RESPONSE1\"\n--batchresponse_761bdf66-72c3-4938-a1f4-3baaf0a7f647\nContent-Type: application/http\nContent-Transfer-Encoding: binary\n\nHTTP/1.1 200 OK\nCONTENT-TYPE: application/json;odata=minimalmetadata;streaming=true;charset=utf-8\n\n\"RESPONSE2\"\n--batchresponse_761bdf66-72c3-4938-a1f4-3baaf0a7f647\nContent-Type: application/http\nContent-Transfer-Encoding: binary\n\nHTTP/1.1 500 Internal Server Error\nCONTENT-TYPE: application/json;odata.metadata=minimal;odata.streaming=true;IEEE754Compatible=false\n\n{ error: { code: \"-2146232832, Microsoft.SharePoint.SPException\",  message: \"Something went wrong.\" } }\n--batchresponse_761bdf66-72c3-4938-a1f4-3baaf0a7f647--\n"
            });
            var spHttpClientBatch = new SPHttpClientBatch_1.default(rootScope, {});
            var fetchPromise1 = spHttpClientBatch.get('http://example.com/_api/test1', SPHttpClientBatch_1.default.configurations.v1, {
                headers: { 'My-Custom-Header': 'header value' }
            }).then(function (response) {
                return response.json();
            }).then(function (responseObject) {
                chai_1.assert.equal(responseObject, 'RESPONSE1');
            });
            var fetchPromise2 = spHttpClientBatch.post('http://example.com/_api/test2', SPHttpClientBatch_1.default.configurations.v1, {
                body: 'BODY2'
            }).then(function (response) {
                return response.json();
            }).then(function (responseObject) {
                chai_1.assert.equal(responseObject, 'RESPONSE2');
            });
            var fetchPromise3 = spHttpClientBatch.fetch('http://example.com/_api/test3', SPHttpClientBatch_1.default.configurations.v1, {
                method: 'GET'
            }).then(function (response) {
                chai_1.assert.fail('Expected an error');
            }).catch(function (error) {
                chai_1.assert.equal(error.message, 'SPHttpClientBatch: Batched request failed');
            });
            var executePromise = spHttpClientBatch.execute()
                .then(function (batch) {
                return;
            });
            Promise.all([fetchPromise1, fetchPromise2, fetchPromise3, executePromise])
                .then(function () {
                fetchProvider.assertQueueEmpty();
                done();
            })
                .catch(function (error) {
                done(error);
            });
        });
    });
});
