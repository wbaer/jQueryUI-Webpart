"use strict";
var path = require("path");
var globEscape = require("glob-escape");
var globby = require("globby");
/* tslint:disable:typedef */
var del = require('del');
/* tslint:disable:typedef */
var FileDeletionUtility = (function () {
    function FileDeletionUtility() {
    }
    FileDeletionUtility.deletePatterns = function (patterns) {
        var files = globby.sync(patterns);
        this.deleteFiles(files);
    };
    FileDeletionUtility.deleteFiles = function (files) {
        del.sync(this.escapeFilepaths(this.removeChildren(files)));
    };
    FileDeletionUtility.escapeFilepaths = function (files) {
        return files.map(function (file) {
            return globEscape(file);
        });
    };
    FileDeletionUtility.removeChildren = function (filenames) {
        // Appears to be a known issue with `del` whereby
        // if you ask to delete both a folder, and something in the folder,
        // it randomly chooses which one to delete first, which can cause
        // the function to fail sporadically. The fix for this is simple:
        // we need to remove any cleanPaths which exist under a folder we
        // are attempting to delete
        // First we sort the list of files. We know that if something is a file,
        // if matched, the parent folder should appear earlier in the list
        filenames.sort();
        // We need to determine which paths exist under other paths, and remove them from the
        // list of files to delete
        var filesToDelete = [];
        // current working directory
        var currentParent = undefined;
        for (var i = 0; i < filenames.length; i++) {
            var curFile = filenames[i];
            if (this.isParentDirectory(currentParent, curFile)) {
                continue;
            }
            else {
                filesToDelete.push(curFile);
                currentParent = curFile;
            }
        }
        return filesToDelete;
    };
    FileDeletionUtility.isParentDirectory = function (directory, filepath) {
        if (!directory || !filepath) {
            return false;
        }
        var directoryParts = path.resolve(directory).split(path.sep);
        var fileParts = path.resolve(filepath).split(path.sep);
        if (directoryParts[directoryParts.length - 1] === '') {
            // this is to fix an issue with windows roots
            directoryParts.pop();
        }
        if (directoryParts.length >= fileParts.length) {
            return false;
        }
        for (var i = 0; i < directoryParts.length; i++) {
            if (directoryParts[i] !== fileParts[i]) {
                return false;
            }
        }
        return true;
    };
    return FileDeletionUtility;
}());
exports.FileDeletionUtility = FileDeletionUtility;

//# sourceMappingURL=FileDeletionUtility.js.map
