{"version":3,"sources":["configureWebpack/ConfigureExternalBundlingWebpackTask.ts"],"names":[],"mappings":"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","file":"configureWebpack/ConfigureExternalBundlingWebpackTask.js","sourcesContent":["import * as lodash from 'lodash';\r\nimport * as gulp from 'gulp';\r\nimport * as path from 'path';\r\nimport * as webpack from 'webpack';\r\nimport { WebpackTask } from '@microsoft/gulp-core-build-webpack';\r\n\r\nimport { getExternalsKeys } from './ExternalsProcessor';\r\nimport { IBundleEntry } from './ConfigureWebpackTask';\r\nimport OdspGulpTask, { ILocaleMap } from './../OdspGulpTask';\r\nimport { ConfigureWebpackTask } from './ConfigureWebpackTask';\r\nimport constants from './../constants';\r\nimport { IWebpackStatsObject, externalsRegex } from './../copyAssets/CopyAssetsTask';\r\n\r\nexport interface IConfigureExternalBundlingWebpackTaskConfig {\r\n  webpack?: WebpackTask;\r\n  localizedResources?: string[];\r\n  configureWebpackTask?: ConfigureWebpackTask;\r\n  debugLocale?: string;\r\n  additionalLoaders?: webpack.Loader[];\r\n  bundleAllLocalizedResources?: boolean;\r\n}\r\n\r\ninterface IResolveResourcesResult {\r\n  locales: string[];\r\n  localizedResourcesToBundle: string[];\r\n}\r\n\r\n/**\r\n * Configures the @microsoft/gulp-core-build-webpack task to bundle localized externals into another, pre-built package.\r\n *\r\n * Example:\r\n *  IN:\r\n *    setConfig({\r\n *      webpack: <reference to webpack task>,\r\n *      localizedResources: <optional - list of localized externals>\r\n *      configureWebpackTask: <reference to the ConfigureWebpackTask task>,\r\n *      debugLocale: <optional - locale to use for a debug build>,\r\n *      additionalLoaders: <optional - additional loaders for localized resources>\r\n *    })\r\n *\r\n *  OUT:\r\n *    If any resources are specified and found, set webpack config to:\r\n *      {\r\n *        entry: <entries with locales>,\r\n *        module: {\r\n *          loaders: ([\r\n *            {\r\n *              loader: 'json-loader',\r\n *              test: /\\.json$/\r\n *            }\r\n *          ] <and additional loaders, if specified>,\r\n *          noParse: [ /\\.map$/ ],\r\n *          postLoaders: [],\r\n *          preLoaders: []\r\n *        },\r\n *        resolve: {\r\n *          alias: <localized resources>,\r\n *          modulesDirectories: [\r\n *            '',\r\n *            'node_modules',\r\n *            'lib'\r\n *          ]\r\n *        },\r\n *        resolveLoader: {\r\n *          root: <node modules folder>\r\n *        },\r\n *        context: <dist directory>,\r\n *        devtool: 'source-map',\r\n *        externals: <externals and non-specified locales>,\r\n *        entry: webpackEntries,\r\n *        output: {\r\n *          libraryTarget: <library target from configureWebpackTask, if specified> or 'amd',\r\n *          path: this.outputDirectory\r\n *        },\r\n *        plugins: []\r\n *      }\r\n */\r\nexport class ConfigureExternalBundlingWebpackTask extends OdspGulpTask<IConfigureExternalBundlingWebpackTaskConfig> {\r\n  public name: string = 'configure-webpack-external-bundling';\r\n  public taskConfig: IConfigureExternalBundlingWebpackTaskConfig = {\r\n    webpack: undefined,\r\n    localizedResources: undefined,\r\n    bundleAllLocalizedResources: false\r\n  };\r\n\r\n  public loadSchema(): Object {\r\n    return require('./configure-webpack-external-bundling.schema.json');\r\n  }\r\n\r\n  public setConfig(config: IConfigureExternalBundlingWebpackTaskConfig): void {\r\n    if (config.webpack && config.webpack.name !== 'webpack') {\r\n      this.logWarning('Setting webpack property to non-\"@microsoft/gulp-core-build-webpack\"-type will ' +\r\n                      'prevent configuration');\r\n    }\r\n\r\n    super.mergeConfig(config);\r\n  }\r\n\r\n  public executeTask(gulp: gulp.Gulp, completeCallback: (error?: string) => void): NodeJS.ReadWriteStream {\r\n    if (!this.taskConfig.webpack) {\r\n      this.logWarning('\"webpack\" is not defined in the task configuration. Nothing to configure.');\r\n      completeCallback();\r\n      return;\r\n    }\r\n\r\n    if (!this.taskConfig.configureWebpackTask) {\r\n      this.logError('\"configureWebpackTask\" is not defined in the task configuration.');\r\n      this._setWebpackConfig(undefined);\r\n      completeCallback();\r\n      return;\r\n    }\r\n\r\n    if (!this._shouldBeEnabled) {\r\n      this.logVerbose('No localized resources specified, nothing to do.');\r\n      this._setWebpackConfig(undefined);\r\n      completeCallback();\r\n      return;\r\n    }\r\n\r\n    if (!this.properties.webpackStats) {\r\n      this.logError('Missing webpack stats object. Unable to configure.');\r\n      this._setWebpackConfig(undefined);\r\n      completeCallback();\r\n      return;\r\n    }\r\n\r\n    const resourcesToBundle: string[] = this._pruneLocalizedResources();\r\n    if (resourcesToBundle.length === 0) {\r\n      this.logVerbose('None of the specified localized resources were present in the webpack stats object. Nothing ' +\r\n                      'to do.');\r\n      this._setWebpackConfig(undefined);\r\n      completeCallback();\r\n      return;\r\n    }\r\n\r\n    // When we run webpack again, it'll overwrite this.properties.webpackStats, and we want to remember the\r\n    //  webpack stats object from the first webpack run.\r\n    this.properties.initialWebpackStats = this.properties.webpackStats;\r\n\r\n    let resolveResult: IResolveResourcesResult;\r\n    try {\r\n      resolveResult = this._resolveResources(resourcesToBundle);\r\n    } catch (error) {\r\n      completeCallback(error);\r\n      return;\r\n    }\r\n\r\n    const locales: string[] = resolveResult.locales;\r\n    const localizedResourcesToBundle: string[] = resolveResult.localizedResourcesToBundle;\r\n\r\n    const externalsKeys: string[] = getExternalsKeys(this);\r\n\r\n    const localizedResources: { [name: string]: string } = this.properties.localizedResources || {};\r\n    const localizedResourcesKeys: string[] = Object.keys(localizedResources).filter((key: string) => {\r\n      return localizedResourcesToBundle.indexOf(key) === -1;\r\n    });\r\n\r\n    if (!this.properties.bundledExternals) {\r\n      this.properties.bundledExternals = [];\r\n    }\r\n\r\n    this.properties.bundledExternals.push(...localizedResourcesToBundle);\r\n\r\n    const webpackEntries: { [name: string]: string } = this._generateWebpackEntries(locales);\r\n\r\n    const config: webpack.Configuration = {\r\n      module: {\r\n        loaders: ([\r\n          {\r\n            loader: 'json-loader',\r\n            test: /\\.json$/\r\n          }\r\n        ] as webpack.Loader[]).concat(this.taskConfig.additionalLoaders || []),\r\n        noParse: [ /\\.map$/ ],\r\n        postLoaders: [],\r\n        preLoaders: this.buildConfig.production\r\n          ? []\r\n          : [\r\n              {\r\n                test:   /\\.js$/,\r\n                loader: 'source-map-loader'\r\n              }\r\n            ]\r\n      },\r\n      resolve: {\r\n        alias: {},\r\n        modulesDirectories: [\r\n          '',\r\n          'node_modules',\r\n          'lib'\r\n        ]\r\n      },\r\n      resolveLoader: {\r\n        root: path.join(__dirname, '..', '..', 'node_modules')\r\n      },\r\n      context: this.outputDirectory,\r\n      devtool: this.buildConfig.production ? undefined : 'source-map',\r\n      externals: externalsKeys.concat(localizedResourcesKeys),\r\n      entry: webpackEntries,\r\n      output: {\r\n        library: this.properties.webpackLibraryName,\r\n        libraryTarget: 'amd',\r\n        path: this.outputDirectory,\r\n        devtoolModuleFilenameTemplate: 'webpack:///../[resource-path]',\r\n        devtoolFallbackModuleFilenameTemplate: 'webpack:///../[resource-path]?[hash]'\r\n      }\r\n    };\r\n\r\n    // VSO#258841: Minification here doesn't make a big deal (<1kb gzipped), but adds a lot of build time.\r\n    //  This can updated eventually to drop a fake base bundle, run webpack, and then replace the fake bundle\r\n    //  with the real payload.\r\n    // if (this.buildConfig.production) {\r\n    //   config.plugins.push(new webpack.optimize.UglifyJsPlugin({\r\n    //     compress: {\r\n    //       dead_code: false,\r\n    //       warnings: false\r\n    //     },\r\n    //     mangle: true\r\n    //   }));\r\n    // }\r\n\r\n    this.taskConfig.configureWebpackTask.tinkerWithLocConfig(config);\r\n\r\n    const configs: webpack.Configuration[] = [];\r\n\r\n    for (const locale of locales) {\r\n      const localeWebpackConfig: webpack.Configuration = lodash.cloneDeep(config);\r\n\r\n      for (const resourceName of localizedResourcesToBundle) {\r\n        const path: string = this.properties.discoveredLocalizedResources[resourceName][locale];\r\n        localeWebpackConfig.resolve.alias[resourceName] = path;\r\n      }\r\n\r\n      localeWebpackConfig.output.filename = `[name]_${locale}.js`;\r\n      localeWebpackConfig.output.chunkFilename = `[id].[name]_${locale}_[chunkhash].js`;\r\n\r\n      configs.push(localeWebpackConfig);\r\n    }\r\n\r\n    this._setWebpackConfig(configs);\r\n\r\n    completeCallback();\r\n  }\r\n\r\n  /**\r\n   * Modify the base webpack config to make sure we get what we need after that webpack intance runs.\r\n   *\r\n   * @internal\r\n   */\r\n  public tinkerWithBaseWebpackConfig(config: webpack.Configuration): void {\r\n    if (this._shouldBeEnabled) {\r\n      config.output.libraryTarget = 'amd';\r\n    }\r\n  }\r\n\r\n  private _resolveResources(localizedResources: string[]): IResolveResourcesResult {\r\n    // Ensure that all localized resoureces specified exist.\r\n    const localizedResourcesToBundle: string[] = [];\r\n    const notFoundResources: string[] = [];\r\n    const mismatchResources: string[] = [];\r\n    let locales: string[];\r\n    for (const resourceName of localizedResources) {\r\n      const discoveredResources: ILocaleMap = (this.properties.discoveredLocalizedResources || {})[resourceName];\r\n      if (!discoveredResources || Object.keys(discoveredResources).length === 0) {\r\n        notFoundResources.push(resourceName);\r\n      } else {\r\n        const resourceLocales: string[] = this._filterLocales(Object.keys(discoveredResources));\r\n        if (!locales) {\r\n          locales = resourceLocales;\r\n          localizedResourcesToBundle.push(resourceName);\r\n          continue;\r\n        }\r\n\r\n        let notMatch: boolean = resourceLocales.length !== locales.length;\r\n        for (let i: number = 0; i < resourceLocales.length && !notMatch; i++) {\r\n          notMatch = notMatch || (locales.indexOf(resourceLocales[i]) === -1);\r\n        }\r\n\r\n        if (notMatch) {\r\n          mismatchResources.push(resourceName);\r\n        } else {\r\n          localizedResourcesToBundle.push(resourceName);\r\n        }\r\n      }\r\n    }\r\n\r\n    if (notFoundResources.length > 0) {\r\n      throw `Specified resources not found: ${notFoundResources.join(', ')}.`;\r\n    }\r\n\r\n    if (mismatchResources.length > 0) {\r\n      throw 'All resources must have exactly the same locales. Some resources do not match the locales ' +\r\n            `specified by the first (${locales.join(', ')}): ${mismatchResources.join(', ')}`;\r\n    }\r\n\r\n    return { locales, localizedResourcesToBundle };\r\n  }\r\n\r\n  private _filterLocales(locales: string[]): string[] {\r\n    if (!this.buildConfig.production) {\r\n      // If this is a non-production build, don't build every locale. Just build the specified or default locale.\r\n      let localeHasBeenFiltered: boolean = false;\r\n      if (locales.indexOf(this.taskConfig.debugLocale) !== -1) {\r\n        locales = [this.taskConfig.debugLocale];\r\n        localeHasBeenFiltered = true;\r\n      } else if (locales.indexOf(constants.defaultLocale) !== -1) {\r\n        locales = [constants.defaultLocale];\r\n        localeHasBeenFiltered = true;\r\n      } else {\r\n        this.logError(`Unable to find a debug locale (${this.taskConfig.debugLocale || 'unspecified'}) or a default ` +\r\n                      `locale (${constants.defaultLocale}). All locales will be built. This may be time-consuming.`);\r\n      }\r\n\r\n      if (localeHasBeenFiltered) {\r\n        this.logVerbose(`Locales have been filtered to ${JSON.stringify(locales)} for debug build.`);\r\n      }\r\n    }\r\n\r\n    return locales;\r\n  }\r\n\r\n  private _generateWebpackEntries(locales: string[]): { [name: string]: string } {\r\n    const entries: IBundleEntry[] = this.properties.bundleEntries || [];\r\n\r\n    const webpackEntries: { [name: string]: string } = {};\r\n    entries.forEach((entry: IBundleEntry) => {\r\n      const entryName: string = path.basename(entry.nonLocalizedEntrypointPath, '.js');\r\n      webpackEntries[entryName] = path.join(this.outputDirectory, `${entryName}.js`);\r\n\r\n      entry.nonLocalizedEntrypointPath = undefined;\r\n      entry.localizedEntrypointPaths = {};\r\n      locales.forEach((locale: string) => {\r\n        entry.localizedEntrypointPaths[locale] = path.join(this.outputDirectory, `${entryName}_${locale}.js`);\r\n      });\r\n    });\r\n\r\n    return webpackEntries;\r\n  }\r\n\r\n  private _pruneLocalizedResources(): string[] {\r\n    const  { modules }: IWebpackStatsObject = this.properties.webpackStats.toJson({ modules: true });\r\n    const filteredResources: string[] = [];\r\n\r\n    for (const module of modules) {\r\n      const matches: string[] = module.name.match(externalsRegex);\r\n      if (matches) {\r\n        const externalName: string = matches[1];\r\n        if ((this.taskConfig.bundleAllLocalizedResources &&\r\n             this.properties.discoveredLocalizedResources[externalName]) ||\r\n            (this.taskConfig.localizedResources && this.taskConfig.localizedResources.indexOf(externalName) !== -1)) {\r\n          filteredResources.push(externalName);\r\n        }\r\n      }\r\n    }\r\n\r\n    return filteredResources;\r\n  }\r\n\r\n  private get _shouldBeEnabled(): boolean {\r\n    return this.taskConfig.configureWebpackTask &&\r\n           (this.taskConfig.bundleAllLocalizedResources &&\r\n            this.taskConfig.configureWebpackTask.properties.discoveredLocalizedResources &&\r\n            Object.keys(this.taskConfig.configureWebpackTask.properties.discoveredLocalizedResources).length !== 0) ||\r\n           (this.taskConfig.localizedResources &&\r\n            this.taskConfig.localizedResources.length !== 0);\r\n  }\r\n\r\n  private _setWebpackConfig(config: webpack.Configuration): void {\r\n    const webpackTask: WebpackTask = this.taskConfig.webpack;\r\n    if (webpackTask) {\r\n      if (!config) {\r\n        // We're just going to disable the second webpack task\r\n        webpackTask.isEnabled = () => false;\r\n      } else {\r\n        webpackTask.setConfig({\r\n          config: config,\r\n          configPath: null // tslint:disable-line:no-null-keyword\r\n        });\r\n      }\r\n    }\r\n  }\r\n}\r\n"],"sourceRoot":"..\\..\\src"}